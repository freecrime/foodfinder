<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FoodFinder</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;500;600;700;800&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500&display=swap" rel="stylesheet">
<!-- PDF.js for client-side PDF parsing -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
  :root {
    --bg: #090909;
    --surface: rgba(255,255,255,0.035);
    --surface-hover: rgba(255,255,255,0.065);
    --surface-active: rgba(255,255,255,0.10);
    --border: rgba(255,255,255,0.08);
    --border-glow: rgba(255,255,255,0.18);
    --text-primary: #f0f0f0;
    --text-secondary: #888;
    --text-muted: #555;
    --accent-dim: rgba(255,255,255,0.12);
    --glow: 0 0 20px rgba(255,255,255,0.07),0 0 60px rgba(255,255,255,0.03);
    --glow-strong: 0 0 20px rgba(255,255,255,0.15),0 0 60px rgba(255,255,255,0.06);
    --radius: 14px;
    --radius-lg: 20px;
    --transition: 0.22s cubic-bezier(0.4,0,0.2,1);
    --font-display: 'Syne', sans-serif;
    --font-body: 'DM Sans', sans-serif;
  }

  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
  html{scroll-behavior:smooth;height:100%}
  body{background:var(--bg);color:var(--text-primary);font-family:var(--font-body);font-size:15px;line-height:1.6;min-height:100vh;overflow-x:hidden;display:flex;flex-direction:column}

  #particle-canvas{position:fixed;inset:0;z-index:0;pointer-events:none;opacity:.5}

  /* ‚îÄ‚îÄ NAVBAR ‚îÄ‚îÄ */
  .navbar{position:sticky;top:0;z-index:100;display:flex;align-items:center;justify-content:space-between;padding:0 24px;height:60px;background:rgba(9,9,9,.88);backdrop-filter:blur(20px);border-bottom:1px solid var(--border)}
  .nav-logo{font-family:var(--font-display);font-size:20px;font-weight:800;letter-spacing:-.5px}
  .nav-logo span{color:var(--text-muted);font-weight:400}
  .nav-right{display:flex;align-items:center;gap:8px;flex-shrink:0}

  .btn-nav{position:relative;background:transparent;border:1px solid var(--border);color:var(--text-secondary);font-family:var(--font-body);font-size:16px;width:36px;height:36px;border-radius:8px;cursor:pointer;transition:var(--transition);display:flex;align-items:center;justify-content:center;flex-shrink:0}
  .btn-nav:hover{color:var(--text-primary);border-color:var(--border-glow);background:var(--surface-hover)}
  .btn-nav::after{content:attr(data-tip);position:absolute;bottom:-34px;left:50%;transform:translateX(-50%);background:#1e1e1e;border:1px solid var(--border);color:var(--text-secondary);font-size:11px;white-space:nowrap;padding:4px 8px;border-radius:5px;pointer-events:none;opacity:0;transition:opacity .15s ease;z-index:200}
  .btn-nav:hover::after{opacity:1}
  .btn-lang{background:var(--surface);border:1px solid var(--border);color:var(--text-primary);font-family:var(--font-display);font-size:12px;font-weight:700;letter-spacing:1.5px;padding:0;width:36px;height:36px;border-radius:8px;cursor:pointer;transition:var(--transition);display:flex;align-items:center;justify-content:center;flex-shrink:0}
  .btn-lang:hover{background:var(--surface-hover);border-color:var(--border-glow);box-shadow:var(--glow)}

  /* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
  .main-container{position:relative;z-index:1;max-width:1100px;margin:0 auto;padding:0 20px 80px;flex:1}
  .footer{position:relative;z-index:1;text-align:center;padding:30px 20px;border-top:1px solid var(--border);font-size:12px;color:var(--text-muted);letter-spacing:.5px;margin-top:auto}

  /* ‚îÄ‚îÄ HERO ‚îÄ‚îÄ */
  .hero{padding:60px 0 40px;text-align:center}
  .hero-eyebrow{font-size:11px;font-weight:500;letter-spacing:3px;color:var(--text-muted);text-transform:uppercase;margin-bottom:16px}
  .hero-title{font-family:var(--font-display);font-size:clamp(32px,6vw,58px);font-weight:800;letter-spacing:-2px;line-height:1.05;margin-bottom:14px}
  .hero-subtitle{color:var(--text-secondary);font-size:15px;font-weight:300;max-width:440px;margin:0 auto 36px}

  .search-box{display:flex;gap:10px;max-width:640px;margin:0 auto}
  .search-input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);color:var(--text-primary);font-family:var(--font-body);font-size:15px;padding:14px 18px;outline:none;transition:var(--transition);backdrop-filter:blur(12px)}
  .search-input::placeholder{color:var(--text-muted)}
  .search-input:focus{border-color:var(--border-glow);background:var(--surface-hover);box-shadow:var(--glow)}
  .btn-search{background:var(--text-primary);color:var(--bg);border:none;border-radius:var(--radius);font-family:var(--font-display);font-size:14px;font-weight:700;padding:14px 24px;cursor:pointer;transition:var(--transition);white-space:nowrap}
  .btn-search:hover{background:#e0e0e0;box-shadow:0 0 30px rgba(255,255,255,.15)}
  .btn-clear-search{background:transparent;border:1px solid var(--border);color:var(--text-secondary);border-radius:var(--radius);font-family:var(--font-body);font-size:13px;padding:14px 16px;cursor:pointer;transition:var(--transition)}
  .btn-clear-search:hover{color:var(--text-primary);border-color:var(--border-glow)}

  /* ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ */
  .filter-section{margin-bottom:30px}
  .filter-toggle{display:flex;align-items:center;gap:8px;background:none;border:1px solid var(--border);color:var(--text-secondary);font-family:var(--font-body);font-size:13px;padding:8px 16px;border-radius:6px;cursor:pointer;transition:var(--transition);margin:0 auto 16px}
  .filter-toggle:hover{color:var(--text-primary);border-color:var(--border-glow)}
  .filter-icon{display:inline-block;transition:transform var(--transition)}
  .filter-icon.open{transform:rotate(180deg)}
  .filter-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:24px;backdrop-filter:blur(16px);display:none;animation:fadeIn .2s ease}
  .filter-panel.visible{display:block}
  .filter-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px}
  .filter-group>label{display:block;font-size:11px;font-weight:600;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-muted);margin-bottom:10px}
  .filter-checkboxes{display:flex;flex-wrap:wrap;gap:8px}
  .filter-chip{display:inline-flex;align-items:center;gap:6px;background:transparent;border:1px solid var(--border);border-radius:6px;padding:6px 12px;font-family:var(--font-body);font-size:12px;color:var(--text-secondary);cursor:pointer;transition:var(--transition);user-select:none}
  .filter-chip input{display:none}
  .filter-chip:hover{border-color:var(--border-glow);color:var(--text-primary)}
  .filter-chip.active{background:var(--accent-dim);border-color:rgba(255,255,255,.3);color:var(--text-primary)}
  .filter-select{background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-family:var(--font-body);font-size:13px;padding:8px 12px;width:100%;outline:none;cursor:pointer;transition:var(--transition)}
  .filter-select:focus{border-color:var(--border-glow)}
  .filter-select option{background:#1a1a1a}
  .filter-range-row{display:flex;align-items:center;gap:10px}
  .filter-range{flex:1;accent-color:#fff;cursor:pointer}
  .filter-range-val{font-size:12px;color:var(--text-secondary);min-width:52px}

  /* ‚îÄ‚îÄ SORT BAR ‚îÄ‚îÄ */
  .sort-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:10px}
  .results-count{font-size:13px;color:var(--text-muted)}
  .sort-group{display:flex;align-items:center;gap:8px}
  .sort-label{font-size:12px;color:var(--text-muted);letter-spacing:1px;text-transform:uppercase}
  .sort-btn{background:transparent;border:1px solid var(--border);color:var(--text-secondary);font-family:var(--font-body);font-size:12px;padding:5px 12px;border-radius:5px;cursor:pointer;transition:var(--transition)}
  .sort-btn:hover{color:var(--text-primary);border-color:var(--border-glow)}
  .sort-btn.active{background:var(--accent-dim);border-color:rgba(255,255,255,.3);color:var(--text-primary)}

  /* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
  .results-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px}

  /* skeleton */
  .skeleton-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;height:310px;animation:pulse 1.5s ease-in-out infinite}
  .skeleton-img{height:160px;background:rgba(255,255,255,.04)}
  .skeleton-body{padding:16px}
  .skeleton-line{height:12px;background:rgba(255,255,255,.04);border-radius:4px;margin-bottom:10px}
  .skeleton-line.short{width:60%}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

  /* recipe card */
  .recipe-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);overflow:hidden;cursor:pointer;transition:var(--transition);animation:fadeIn .3s ease;display:flex;flex-direction:column}
  .recipe-card:hover{background:var(--surface-hover);border-color:var(--border-glow);transform:translateY(-3px);box-shadow:var(--glow-strong)}
  .recipe-card.local-card{border-color:rgba(255,255,255,.12)}
  .card-img-wrap{position:relative;height:160px;overflow:hidden;background:rgba(255,255,255,.03)}
  .card-img{width:100%;height:100%;object-fit:cover;transition:transform .4s ease;filter:brightness(.85)}
  .recipe-card:hover .card-img{transform:scale(1.04);filter:brightness(.95)}
  .card-placeholder{width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-family:var(--font-display);font-size:40px;color:var(--text-muted);letter-spacing:-1px}
  .card-fav-btn{position:absolute;top:10px;right:10px;background:rgba(9,9,9,.75);border:1px solid var(--border);border-radius:6px;color:var(--text-muted);font-size:11px;font-family:var(--font-body);padding:5px 9px;cursor:pointer;transition:var(--transition);backdrop-filter:blur(8px);z-index:2}
  .card-fav-btn:hover,.card-fav-btn.saved{color:var(--text-primary);border-color:var(--border-glow);background:rgba(255,255,255,.12)}
  .local-badge{position:absolute;top:10px;left:10px;background:rgba(9,9,9,.75);border:1px solid rgba(255,255,255,.2);border-radius:4px;font-size:9px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;padding:3px 8px;color:var(--text-secondary);backdrop-filter:blur(8px)}
  .card-tags{position:absolute;bottom:10px;left:10px;display:flex;gap:5px;flex-wrap:wrap}
  .card-top-left{position:absolute;top:10px;left:10px;display:flex;gap:5px;align-items:center;flex-wrap:wrap;max-width:calc(100% - 80px)}
  .tag{font-size:10px;font-weight:600;letter-spacing:.8px;text-transform:uppercase;padding:3px 8px;border-radius:4px;background:rgba(9,9,9,.75);backdrop-filter:blur(8px);border:1px solid var(--border);color:var(--text-secondary)}
  .card-body{padding:16px;flex:1;display:flex;flex-direction:column}
  .card-title{font-family:var(--font-display);font-size:16px;font-weight:700;color:var(--text-primary);margin-bottom:6px;line-height:1.3;letter-spacing:-.3px}
  .card-desc{font-size:12px;color:var(--text-muted);line-height:1.5;margin-bottom:8px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
  .card-meta{display:flex;gap:14px;margin-top:auto;padding-top:12px;border-top:1px solid var(--border);flex-wrap:wrap}
  .meta-item{font-size:11px;color:var(--text-muted);display:flex;flex-direction:column;gap:2px}
  .meta-item strong{font-size:13px;color:var(--text-secondary);font-weight:500}

  /* state messages */
  .state-msg{text-align:center;padding:60px 20px;color:var(--text-muted);grid-column:1/-1}
  .state-msg h3{font-family:var(--font-display);font-size:20px;color:var(--text-secondary);margin-bottom:8px;font-weight:600}
  .state-msg p{font-size:13px}

  /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
  .modal-overlay{position:fixed;inset:0;z-index:200;background:rgba(0,0,0,.82);backdrop-filter:blur(6px);display:flex;align-items:flex-start;justify-content:center;padding:24px 16px;overflow-y:auto;opacity:0;pointer-events:none;transition:opacity var(--transition)}
  .modal-overlay.open{opacity:1;pointer-events:all}
  .modal{background:#111;border:1px solid var(--border);border-radius:var(--radius-lg);width:100%;max-width:720px;overflow:hidden;transform:translateY(20px) scale(.98);transition:transform var(--transition);margin:auto}
  .modal-overlay.open .modal{transform:translateY(0) scale(1)}
  .modal-img{width:100%;height:260px;object-fit:cover;display:block;filter:brightness(.75)}
  .modal-img-placeholder{width:100%;height:120px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.03);font-family:var(--font-display);font-size:52px;color:var(--text-muted)}
  .modal-header{padding:22px 28px 16px;border-bottom:1px solid var(--border)}
  .modal-title{font-family:var(--font-display);font-size:clamp(20px,4vw,28px);font-weight:800;letter-spacing:-.8px;margin-bottom:10px;line-height:1.2}
  .modal-meta{display:flex;gap:20px;flex-wrap:wrap}
  .modal-meta-item{font-size:12px;color:var(--text-muted);display:flex;flex-direction:column}
  .modal-meta-item strong{color:var(--text-secondary);font-size:14px}
  .modal-body{padding:24px 28px}
  .modal-section-title{font-family:var(--font-display);font-size:11px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--text-muted);margin-bottom:14px;margin-top:22px}
  .modal-section-title:first-child{margin-top:0}
  .ingredients-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:8px;margin-bottom:6px}
  .ingredient-item{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:8px 12px;font-size:13px;color:var(--text-secondary)}
  .instruction-step{display:flex;gap:14px;margin-bottom:16px;align-items:flex-start}
  .step-num{flex-shrink:0;width:26px;height:26px;border-radius:50%;background:var(--surface-active);border:1px solid var(--border);font-size:11px;font-weight:700;font-family:var(--font-display);display:flex;align-items:center;justify-content:center;color:var(--text-secondary);margin-top:2px}
  .step-text{font-size:14px;color:var(--text-secondary);line-height:1.7}
  .modal-footer{padding:16px 28px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
  .btn-close-modal{background:transparent;border:1px solid var(--border);color:var(--text-secondary);font-family:var(--font-body);font-size:13px;padding:10px 20px;border-radius:8px;cursor:pointer;transition:var(--transition)}
  .btn-close-modal:hover{color:var(--text-primary);border-color:var(--border-glow)}
  .btn-save-recipe{background:var(--text-primary);color:var(--bg);border:none;border-radius:8px;font-family:var(--font-display);font-size:13px;font-weight:700;padding:10px 22px;cursor:pointer;transition:var(--transition)}
  .btn-save-recipe:hover{background:#e0e0e0}
  .btn-save-recipe.saved{background:var(--surface-active);color:var(--text-secondary);border:1px solid var(--border)}
  .translate-notice{font-size:11px;color:var(--text-muted);padding:10px 28px;border-top:1px solid var(--border);background:rgba(255,255,255,.01);display:none}
  .translate-notice.visible{display:block}
  .modal-loading{padding:40px 28px;text-align:center;color:var(--text-muted);font-size:13px}
  .btn-translate{background:transparent;border:1px solid var(--border);color:var(--text-secondary);font-family:var(--font-body);font-size:12px;padding:8px 16px;border-radius:7px;cursor:pointer;transition:var(--transition);display:flex;align-items:center;gap:6px}
  .btn-translate:hover{color:var(--text-primary);border-color:var(--border-glow);background:var(--surface-hover)}
  .btn-translate:disabled{opacity:.45;cursor:default}
  .translate-spinner{display:none;width:12px;height:12px;border:2px solid rgba(255,255,255,.15);border-top-color:rgba(255,255,255,.7);border-radius:50%;animation:spin .7s linear infinite}
  .btn-translate.translating .translate-spinner{display:inline-block}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* ‚îÄ‚îÄ SECTION / FAVS ‚îÄ‚îÄ */
  .section-divider{height:1px;background:var(--border);margin:50px 0 40px}
  .section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px;flex-wrap:wrap;gap:12px}
  .section-title{font-family:var(--font-display);font-size:22px;font-weight:800;letter-spacing:-.8px}
  .btn-secondary{background:transparent;border:1px solid var(--border);color:var(--text-muted);font-family:var(--font-body);font-size:12px;padding:6px 14px;border-radius:6px;cursor:pointer;transition:var(--transition)}
  .btn-secondary:hover{color:var(--text-primary);border-color:var(--border-glow)}

  /* ‚îÄ‚îÄ PDF UPLOAD PANEL ‚îÄ‚îÄ */
  .upload-panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-lg);padding:28px;margin-bottom:32px;backdrop-filter:blur(16px);display:none;animation:fadeIn .2s ease}
  .upload-panel.visible{display:block}
  .upload-drop-zone{border:1px dashed rgba(255,255,255,.15);border-radius:var(--radius);padding:36px 20px;text-align:center;cursor:pointer;transition:var(--transition);position:relative}
  .upload-drop-zone:hover,.upload-drop-zone.drag-over{border-color:rgba(255,255,255,.35);background:rgba(255,255,255,.03)}
  .upload-drop-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
  .upload-icon{font-size:32px;color:var(--text-muted);margin-bottom:12px;display:block}
  .upload-title{font-family:var(--font-display);font-size:16px;font-weight:700;margin-bottom:6px}
  .upload-sub{font-size:12px;color:var(--text-muted)}
  .upload-progress{margin-top:16px;display:none}
  .upload-progress.visible{display:block}
  .progress-bar-wrap{height:3px;background:rgba(255,255,255,.08);border-radius:2px;overflow:hidden;margin-top:8px}
  .progress-bar{height:100%;background:#fff;border-radius:2px;transition:width .3s ease;width:0%}
  .progress-label{font-size:12px;color:var(--text-muted)}
  .local-recipes-list{margin-top:20px;display:flex;flex-direction:column;gap:10px}
  .local-recipe-row{background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:10px;padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;transition:var(--transition)}
  .local-recipe-row:hover{border-color:var(--border-glow)}
  .local-recipe-info{flex:1;min-width:0}
  .local-recipe-name{font-family:var(--font-display);font-size:14px;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .local-recipe-meta{font-size:11px;color:var(--text-muted);margin-top:2px}
  .local-recipe-actions{display:flex;gap:8px;flex-shrink:0}
  .btn-tiny{background:transparent;border:1px solid var(--border);color:var(--text-secondary);font-family:var(--font-body);font-size:11px;padding:4px 10px;border-radius:5px;cursor:pointer;transition:var(--transition);white-space:nowrap}
  .btn-tiny:hover{color:var(--text-primary);border-color:var(--border-glow)}
  .btn-tiny.danger:hover{color:#ff6b6b;border-color:rgba(255,100,100,.3)}

  /* loading dots */
  .loading-dots{display:inline-flex;gap:6px}
  .loading-dot{width:7px;height:7px;border-radius:50%;background:var(--text-muted);animation:dot-bounce 1.2s ease-in-out infinite}
  .loading-dot:nth-child(2){animation-delay:.2s}
  .loading-dot:nth-child(3){animation-delay:.4s}
  @keyframes dot-bounce{0%,80%,100%{transform:scale(.6);opacity:.4}40%{transform:scale(1);opacity:1}}

  @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

  /* ‚îÄ‚îÄ SCORE ‚îÄ‚îÄ */
  .score-section{margin-top:18px;padding-top:16px;border-top:1px solid var(--border)}
  .score-label{font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-muted);margin-bottom:10px;display:block}
  .score-row{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
  .score-slider{flex:1;min-width:120px;accent-color:#fff;cursor:pointer}
  .score-value{font-family:var(--font-display);font-size:20px;font-weight:800;color:var(--text-primary);min-width:38px;text-align:right}
  .score-emoji{font-size:20px}
  .btn-save-score{background:var(--surface-active);border:1px solid var(--border);color:var(--text-secondary);font-family:var(--font-body);font-size:12px;padding:6px 14px;border-radius:6px;cursor:pointer;transition:var(--transition)}
  .btn-save-score:hover{color:var(--text-primary);border-color:var(--border-glow)}
  .score-badge{display:inline-block;background:var(--surface-active);border:1px solid var(--border);border-radius:5px;font-family:var(--font-display);font-size:11px;font-weight:700;padding:2px 8px;color:var(--text-secondary);margin-left:8px;vertical-align:middle}
  .card-score{position:absolute;bottom:10px;right:10px;background:rgba(9,9,9,.82);border:1px solid rgba(255,255,255,.18);border-radius:5px;font-size:10px;font-weight:700;font-family:var(--font-display);padding:3px 7px;color:var(--text-primary);backdrop-filter:blur(8px)}

  /* ‚îÄ‚îÄ PDF AI BADGE ‚îÄ‚îÄ */
  .ai-parsed-note{font-size:11px;color:var(--text-muted);padding:8px 12px;background:rgba(255,255,255,.025);border:1px solid var(--border);border-radius:7px;margin-bottom:14px;display:flex;align-items:center;gap:6px}
  .ing-uncertain{border-style:dashed;opacity:.7}

  /* ‚îÄ‚îÄ FAVORITES FOLDERS ‚îÄ‚îÄ */
  .fav-controls{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;margin-bottom:18px}
  .fav-sort-group{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
  .fav-sort-label{font-size:11px;color:var(--text-muted);text-transform:uppercase;letter-spacing:1px;white-space:nowrap}
  .fav-sort-btn{background:transparent;border:1px solid var(--border);color:var(--text-secondary);font-family:var(--font-body);font-size:11px;padding:4px 10px;border-radius:5px;cursor:pointer;transition:var(--transition);white-space:nowrap}
  .fav-sort-btn:hover{color:var(--text-primary);border-color:var(--border-glow)}
  .fav-sort-btn.active{background:var(--accent-dim);border-color:rgba(255,255,255,.3);color:var(--text-primary)}
  .folders-bar{display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-bottom:20px}
  .folder-tab{display:inline-flex;align-items:center;gap:6px;background:transparent;border:1px solid var(--border);color:var(--text-secondary);font-family:var(--font-body);font-size:12px;padding:5px 12px;border-radius:20px;cursor:pointer;transition:var(--transition);white-space:nowrap;user-select:none}
  .folder-tab:hover{border-color:var(--border-glow);color:var(--text-primary)}
  .folder-tab.active{background:var(--accent-dim);border-color:rgba(255,255,255,.3);color:var(--text-primary)}
  .folder-tab .folder-count{font-size:10px;color:var(--text-muted);background:rgba(255,255,255,.07);border-radius:10px;padding:1px 6px;min-width:18px;text-align:center}
  .folder-tab.active .folder-count{color:var(--text-secondary)}
  .btn-new-folder{display:inline-flex;align-items:center;gap:5px;background:transparent;border:1px dashed rgba(255,255,255,.15);color:var(--text-muted);font-family:var(--font-body);font-size:12px;padding:5px 12px;border-radius:20px;cursor:pointer;transition:var(--transition)}
  .btn-new-folder:hover{border-color:var(--border-glow);color:var(--text-primary)}
  .folder-tab .folder-del{opacity:0;font-size:11px;color:var(--text-muted);margin-left:2px;transition:opacity .15s;line-height:1;padding:0 2px;background:none;border:none;cursor:pointer;color:inherit}
  .folder-tab:hover .folder-del{opacity:1}
  .folder-del:hover{color:#ff6b6b!important}
  .card-folder-btn{display:inline-flex;align-items:center;background:rgba(9,9,9,.75);border:1px solid var(--border);border-radius:6px;color:var(--text-muted);font-size:10px;font-family:var(--font-body);padding:3px 8px;cursor:pointer;transition:var(--transition);backdrop-filter:blur(8px);z-index:3;max-width:110px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
  .card-folder-btn:hover,.card-folder-btn.assigned{color:var(--text-secondary);border-color:rgba(255,255,255,.18)}
  .folder-picker{position:fixed;z-index:9999;background:#161616;border:1px solid var(--border-glow);border-radius:10px;padding:6px;min-width:170px;box-shadow:0 8px 32px rgba(0,0,0,.7);animation:fadeIn .12s ease}
  .folder-picker-item{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:6px;font-size:13px;color:var(--text-secondary);cursor:pointer;transition:background .12s;white-space:nowrap}
  .folder-picker-item:hover{background:var(--surface-hover);color:var(--text-primary)}
  .folder-picker-item.current{color:var(--text-primary)}
  .folder-picker-divider{height:1px;background:var(--border);margin:4px 0}

  /* ‚îÄ‚îÄ EDIT MODAL ‚îÄ‚îÄ */
  .edit-overlay{position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.88);backdrop-filter:blur(8px);display:flex;align-items:flex-start;justify-content:center;padding:20px 16px;overflow-y:auto;opacity:0;pointer-events:none;transition:opacity var(--transition)}
  .edit-overlay.open{opacity:1;pointer-events:all}
  .edit-modal{background:#111;border:1px solid var(--border);border-radius:var(--radius-lg);width:100%;max-width:680px;overflow:hidden;transform:translateY(20px) scale(.98);transition:transform var(--transition);margin:auto}
  .edit-overlay.open .edit-modal{transform:translateY(0) scale(1)}
  .edit-modal-header{padding:20px 24px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px}
  .edit-modal-title{font-family:var(--font-display);font-size:18px;font-weight:800;letter-spacing:-.5px}
  .edit-modal-body{padding:20px 24px;display:flex;flex-direction:column;gap:18px;max-height:68vh;overflow-y:auto}
  .edit-field-label{font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-muted);margin-bottom:7px;display:block}
  .edit-input{background:var(--surface);border:1px solid var(--border);border-radius:8px;color:var(--text-primary);font-family:var(--font-body);font-size:14px;padding:10px 14px;width:100%;outline:none;transition:var(--transition)}
  .edit-input:focus{border-color:var(--border-glow);background:var(--surface-hover)}
  .edit-ing-list{display:flex;flex-direction:column;gap:6px}
  .edit-ing-row{display:flex;gap:8px;align-items:center}
  .edit-ing-input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:7px;color:var(--text-primary);font-family:var(--font-body);font-size:13px;padding:8px 12px;outline:none;transition:var(--transition)}
  .edit-ing-input:focus{border-color:var(--border-glow)}
  .btn-remove-row{background:transparent;border:1px solid var(--border);color:var(--text-muted);width:28px;height:28px;border-radius:5px;cursor:pointer;font-size:16px;line-height:1;transition:var(--transition);display:flex;align-items:center;justify-content:center;flex-shrink:0}
  .btn-remove-row:hover{color:#ff6b6b;border-color:rgba(255,100,100,.3);background:rgba(255,100,100,.06)}
  .btn-add-row{background:transparent;border:1px dashed rgba(255,255,255,.15);color:var(--text-muted);font-family:var(--font-body);font-size:12px;padding:7px 14px;border-radius:7px;cursor:pointer;transition:var(--transition);width:100%;text-align:center;margin-top:4px}
  .btn-add-row:hover{border-color:var(--border-glow);color:var(--text-primary)}
  .edit-step-list{display:flex;flex-direction:column;gap:8px}
  .edit-step-row{display:flex;gap:8px;align-items:flex-start}
  .edit-step-num{flex-shrink:0;width:26px;height:26px;border-radius:50%;background:var(--surface-active);border:1px solid var(--border);font-size:11px;font-weight:700;font-family:var(--font-display);display:flex;align-items:center;justify-content:center;color:var(--text-secondary);margin-top:6px}
  .edit-step-ta{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:7px;color:var(--text-primary);font-family:var(--font-body);font-size:13px;padding:8px 12px;outline:none;transition:var(--transition);resize:vertical;min-height:56px;line-height:1.6}
  .edit-step-ta:focus{border-color:var(--border-glow)}
  .edit-modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
  .btn-edit-save{background:var(--text-primary);color:var(--bg);border:none;border-radius:8px;font-family:var(--font-display);font-size:13px;font-weight:700;padding:10px 22px;cursor:pointer;transition:var(--transition)}
  .btn-edit-save:hover{background:#e0e0e0}
  .btn-edit-cancel{background:transparent;border:1px solid var(--border);color:var(--text-secondary);font-family:var(--font-body);font-size:13px;padding:10px 18px;border-radius:8px;cursor:pointer;transition:var(--transition)}
  .btn-edit-cancel:hover{color:var(--text-primary);border-color:var(--border-glow)}
  .btn-tiny.edit-btn:hover{color:#7eb8ff;border-color:rgba(100,160,255,.35)}
  #btn-modal-edit:hover{color:var(--text-primary);border-color:var(--border-glow);background:var(--surface-hover)}
  .edit-img-upload{border:1px dashed rgba(255,255,255,.18);border-radius:var(--radius);overflow:hidden;cursor:pointer;transition:var(--transition);position:relative;background:var(--surface)}
  .edit-img-upload:hover{border-color:rgba(255,255,255,.35);background:var(--surface-hover)}
  .edit-img-preview{width:100%;height:160px;object-fit:cover;display:block;border-radius:var(--radius)}
  .edit-img-placeholder{height:120px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;color:var(--text-muted);font-size:13px}
  .edit-img-placeholder span{font-size:28px}
  .edit-img-input{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%}
  .edit-img-remove{position:absolute;top:8px;right:8px;background:rgba(9,9,9,.8);border:1px solid var(--border);border-radius:6px;color:var(--text-secondary);font-size:11px;padding:3px 8px;cursor:pointer;backdrop-filter:blur(8px);transition:var(--transition)}
  .edit-img-remove:hover{color:#ff6b6b;border-color:rgba(255,100,100,.3)}
  #local-section{display:none}

  @media(max-width:700px){
    .navbar{padding:0 14px;height:56px}
    .nav-logo{font-size:17px}
    .nav-right{gap:6px}
  }
  @media(max-width:600px){
    .edit-modal-header,.edit-modal-body,.edit-modal-footer{padding-left:14px;padding-right:14px}
    .edit-modal-body{max-height:62vh}
    .edit-modal-footer{flex-direction:column}
    .btn-edit-save,.btn-edit-cancel{width:100%;text-align:center}
  }
  @media(max-width:600px){
    .hero{padding:40px 0 28px}
    .search-box{flex-wrap:wrap}
    .btn-search{flex:1}
    .filter-grid,.ingredients-list{grid-template-columns:1fr}
    .modal-img{height:170px}
    .modal-header,.modal-body,.modal-footer{padding-left:14px;padding-right:14px}
    .modal-footer{flex-direction:column;gap:8px}
    .modal-footer>div{width:100%;display:flex;flex-direction:column;gap:8px}
    .btn-save-recipe,.btn-close-modal,.btn-translate{width:100%;text-align:center;justify-content:center}
    .results-grid{grid-template-columns:1fr}
    .nav-right{gap:6px}
    .local-recipe-row{flex-direction:column;align-items:flex-start}
    .local-recipe-actions{width:100%;justify-content:flex-start}
    .sort-bar{flex-direction:column;align-items:flex-start}
  }
  ::-webkit-scrollbar{width:5px}
  ::-webkit-scrollbar-track{background:transparent}
  ::-webkit-scrollbar-thumb{background:#333;border-radius:3px}
</style>
</head>
<body>

<canvas id="particle-canvas"></canvas>

<!-- NAVBAR -->
<nav class="navbar">
  <div class="nav-logo">Food<span>Finder</span></div>
  <div class="nav-right">
    <button class="btn-nav" id="btn-toggle-upload" data-tip="Add Recipe" title="Add Recipe">&#8679;</button>
    <button class="btn-nav" id="btn-show-local" data-tip="My Recipes" title="My Recipes">&#9776;</button>
    <button class="btn-nav" id="btn-show-favs" data-tip="Favorites" title="Favorites">&#9825;</button>
    <button class="btn-lang" id="btn-lang">DE</button>
    <button class="btn-nav" id="btn-changelog" data-tip="Changelog" title="Changelog" style="font-size:13px;font-weight:700">!</button>
  </div>
</nav>

<!-- CHANGELOG MODAL -->
<div id="changelog-overlay" style="display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.82);backdrop-filter:blur(6px);align-items:center;justify-content:center;padding:24px 16px">
  <div style="background:#111;border:1px solid rgba(255,255,255,.12);border-radius:16px;width:100%;max-width:480px;overflow:hidden;box-shadow:0 0 40px rgba(0,0,0,.6)">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid rgba(255,255,255,.08)">
      <span style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;letter-spacing:-.4px">Changelog</span>
      <button id="btn-close-changelog" style="background:transparent;border:1px solid rgba(255,255,255,.1);border-radius:6px;color:#888;font-size:14px;width:28px;height:28px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:.2s ease">‚úï</button>
    </div>
    <div style="padding:20px 22px;max-height:420px;overflow-y:auto">
      <div style="margin-bottom:20px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
          <span style="font-family:'Syne',sans-serif;font-size:14px;font-weight:800">v1.2</span>
          <span style="font-size:10px;letter-spacing:1px;text-transform:uppercase;color:#555;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:4px;padding:2px 8px">Latest</span>
        </div>
        <ul style="list-style:none;display:flex;flex-direction:column;gap:7px">
          <li style="font-size:13px;color:#999;padding-left:14px;position:relative"><span style="position:absolute;left:0;color:#555">+</span> Share recipes via copy-paste code ‚Äî works across any device</li>
          <li style="font-size:13px;color:#999;padding-left:14px;position:relative"><span style="position:absolute;left:0;color:#555">+</span> Import recipes from share codes in the upload panel</li>
        </ul>
      </div>
      <div style="margin-bottom:20px">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:10px">
          <span style="font-family:'Syne',sans-serif;font-size:14px;font-weight:800">v1.1</span>
        </div>
        <ul style="list-style:none;display:flex;flex-direction:column;gap:7px">
          <li style="font-size:13px;color:#999;padding-left:14px;position:relative"><span style="position:absolute;left:0;color:#555">+</span> Added folder system for organizing saved recipes</li>
          <li style="font-size:13px;color:#999;padding-left:14px;position:relative"><span style="position:absolute;left:0;color:#555">+</span> Added confirmation dialog when deleting recipes</li>
        </ul>
      </div>
      <div style="margin-bottom:20px">
        <div style="margin-bottom:10px">
          <span style="font-family:'Syne',sans-serif;font-size:14px;font-weight:800">v1.0</span>
        </div>
        <ul style="list-style:none;display:flex;flex-direction:column;gap:7px">
          <li style="font-size:13px;color:#999;padding-left:14px;position:relative"><span style="position:absolute;left:0;color:#555">+</span> Initial release</li>
          <li style="font-size:13px;color:#999;padding-left:14px;position:relative"><span style="position:absolute;left:0;color:#555">+</span> Ingredient-based recipe search via MealDB API</li>
          <li style="font-size:13px;color:#999;padding-left:14px;position:relative"><span style="position:absolute;left:0;color:#555">+</span> Local recipe import from PDF with AI parsing</li>
          <li style="font-size:13px;color:#999;padding-left:14px;position:relative"><span style="position:absolute;left:0;color:#555">+</span> Save recipes to favorites</li>
          <li style="font-size:13px;color:#999;padding-left:14px;position:relative"><span style="position:absolute;left:0;color:#555">+</span> Rate recipes with a score</li>
          <li style="font-size:13px;color:#999;padding-left:14px;position:relative"><span style="position:absolute;left:0;color:#555">+</span> German / English interface &amp; translation</li>
          <li style="font-size:13px;color:#999;padding-left:14px;position:relative"><span style="position:absolute;left:0;color:#555">+</span> Filter by diet, difficulty, and cook time</li>
        </ul>
      </div>
    </div>
  </div>
</div>

<div class="main-container">

  <!-- HERO -->
  <section class="hero">
    <p class="hero-eyebrow" data-i18n="hero.eyebrow">Ingredient-based recipe discovery</p>
    <h1 class="hero-title" data-i18n="hero.title">What's in your kitchen?</h1>
    <p class="hero-subtitle" data-i18n="hero.subtitle">Enter ingredients you have and we'll find recipes you can make right now.</p>
    <div class="search-box">
      <input type="text" id="search-input" class="search-input" data-i18n-placeholder="search.placeholder" placeholder="e.g. chicken, garlic, tomatoes..." autocomplete="off">
      <button class="btn-search" id="btn-search" data-i18n="search.btn">Search</button>
      <button class="btn-clear-search" id="btn-clear" data-i18n="search.clear">Clear</button>
    </div>
  </section>

  <!-- PDF UPLOAD PANEL -->
  <section class="upload-panel" id="upload-panel">
    <div class="section-header" style="margin-bottom:18px">
      <h2 class="section-title" data-i18n="upload.title">Add Local Recipe</h2>
    </div>
    <div class="upload-drop-zone" id="drop-zone">
      <input type="file" id="pdf-file-input" accept=".pdf" multiple>
      <span class="upload-icon">&#8679;</span>
      <p class="upload-title" data-i18n="upload.dropTitle">Drop your recipe PDFs here</p>
      <p class="upload-sub" data-i18n="upload.dropSub">or click to browse &mdash; supports multiple files &mdash; stored locally in browser</p>
    </div>
    <div class="upload-progress" id="upload-progress">
      <p class="progress-label" id="progress-label">Processing...</p>
      <div class="progress-bar-wrap"><div class="progress-bar" id="progress-bar"></div></div>
    </div>
    <div class="local-recipes-list" id="local-recipes-list"></div>

    <!-- IMPORT FROM CODE -->
    <div style="margin-top:22px;padding-top:20px;border-top:1px solid var(--border)">
      <p style="font-size:11px;font-weight:700;letter-spacing:1.5px;text-transform:uppercase;color:var(--text-muted);margin-bottom:12px">Import from Code</p>
      <div style="display:flex;gap:10px;align-items:flex-end">
        <textarea id="import-code-input" placeholder="Paste a recipe share code here..." style="flex:1;background:var(--surface);border:1px solid var(--border);border-radius:10px;color:var(--text-primary);font-family:var(--font-body);font-size:12px;padding:10px 14px;outline:none;resize:vertical;min-height:64px;line-height:1.5;transition:border-color .22s"></textarea>
        <button id="btn-import-code" style="background:var(--text-primary);color:var(--bg);border:none;border-radius:10px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;padding:10px 18px;cursor:pointer;white-space:nowrap;height:42px">Import</button>
      </div>
      <p id="import-status" style="font-size:12px;margin-top:8px;display:none"></p>
    </div>
  </section>

  <!-- SHARE RECIPE MODAL -->
  <div id="share-overlay" style="display:none;position:fixed;inset:0;z-index:300;background:rgba(0,0,0,.85);backdrop-filter:blur(6px);align-items:center;justify-content:center;padding:24px 16px">
    <div style="background:#111;border:1px solid rgba(255,255,255,.12);border-radius:16px;width:100%;max-width:520px;box-shadow:0 0 40px rgba(0,0,0,.7)">
      <div style="display:flex;align-items:center;justify-content:space-between;padding:18px 22px;border-bottom:1px solid rgba(255,255,255,.08)">
        <div>
          <span style="font-family:'Syne',sans-serif;font-size:16px;font-weight:800;letter-spacing:-.4px">Share Recipe</span>
          <p id="share-recipe-name" style="font-size:12px;color:#555;margin-top:2px"></p>
        </div>
        <button id="btn-close-share" style="background:transparent;border:1px solid rgba(255,255,255,.1);border-radius:6px;color:#888;font-size:14px;width:28px;height:28px;cursor:pointer;display:flex;align-items:center;justify-content:center">&#x2715;</button>
      </div>
      <div style="padding:20px 22px">
        <p style="font-size:12px;color:#666;margin-bottom:12px;line-height:1.6">Copy this code and paste it into FoodFinder on any device to import the recipe. The code contains all recipe data except the photo.</p>
        <textarea id="share-code-output" readonly style="width:100%;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);border-radius:10px;color:#ccc;font-family:monospace;font-size:11px;padding:12px;outline:none;resize:none;line-height:1.5;height:130px;word-break:break-all;display:block"></textarea>
        <div style="display:flex;gap:10px;margin-top:14px">
          <button id="btn-copy-share-code" style="flex:1;background:#f0f0f0;color:#090909;border:none;border-radius:10px;font-family:'Syne',sans-serif;font-size:13px;font-weight:700;padding:11px;cursor:pointer">Copy Code</button>
          <button id="btn-close-share-2" style="background:transparent;border:1px solid rgba(255,255,255,.1);color:#888;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:13px;padding:11px 20px;cursor:pointer">Close</button>
        </div>
      </div>
    </div>
  </div>

  <!-- FILTERS -->
  <section class="filter-section">
    <button class="filter-toggle" id="filter-toggle">
      <span data-i18n="filter.toggle">Filters</span>
      <span class="filter-icon" id="filter-icon">&#9660;</span>
    </button>
    <div class="filter-panel" id="filter-panel">
      <div class="filter-grid">
        <div class="filter-group">
          <label data-i18n="filter.diet">Diet</label>
          <div class="filter-checkboxes">
            <label class="filter-chip" id="chip-vegetarian"><input type="checkbox" id="f-vegetarian"><span data-i18n="filter.vegetarian">Vegetarian</span></label>
            <label class="filter-chip" id="chip-vegan"><input type="checkbox" id="f-vegan"><span data-i18n="filter.vegan">Vegan</span></label>
            <label class="filter-chip" id="chip-gluten"><input type="checkbox" id="f-gluten"><span data-i18n="filter.glutenFree">Gluten Free</span></label>
            <label class="filter-chip" id="chip-dairy"><input type="checkbox" id="f-dairy"><span data-i18n="filter.dairyFree">Dairy Free</span></label>
          </div>
        </div>
        <div class="filter-group">
          <label data-i18n="filter.difficulty">Difficulty</label>
          <select class="filter-select" id="f-difficulty">
            <option value="" data-i18n="filter.any">Any</option>
            <option value="easy" data-i18n="filter.easy">Easy</option>
            <option value="medium" data-i18n="filter.medium">Medium</option>
            <option value="hard" data-i18n="filter.hard">Hard</option>
          </select>
        </div>
        <div class="filter-group">
          <label data-i18n="filter.maxTime">Max Cooking Time</label>
          <div class="filter-range-row">
            <input type="range" id="f-time" class="filter-range" min="10" max="120" step="5" value="120">
            <span class="filter-range-val" id="f-time-val">Any</span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- SORT BAR -->
  <div class="sort-bar" id="sort-bar" style="display:none">
    <div class="results-count" id="results-count"></div>
    <div class="sort-group">
      <span class="sort-label" data-i18n="sort.label">Sort:</span>
      <button class="sort-btn active" data-sort="relevance" data-i18n="sort.relevance">Relevance</button>
      <button class="sort-btn" data-sort="time" data-i18n="sort.time">Time</button>
      <button class="sort-btn" data-sort="calories" data-i18n="sort.calories">Calories</button>
    </div>
  </div>

  <!-- RESULTS -->
  <div class="results-grid" id="results-grid"></div>

  <!-- FAVORITES -->
  <div id="favorites-section" style="display:none">
    <div class="section-divider"></div>
    <div class="section-header">
      <h2 class="section-title" data-i18n="fav.title">Saved Recipes</h2>
      <button class="btn-secondary" id="btn-clear-all-fav" data-i18n="fav.clearAll">Clear All</button>
    </div>
    <!-- Sort + folder controls -->
    <div class="fav-controls">
      <div class="fav-sort-group">
        <span class="fav-sort-label">Sort:</span>
        <button class="fav-sort-btn active" data-fsort="added">Date added</button>
        <button class="fav-sort-btn" data-fsort="alpha">A‚ÄìZ</button>
        <button class="fav-sort-btn" data-fsort="score">Score</button>
        <button class="fav-sort-btn" data-fsort="time">Time</button>
      </div>
    </div>
    <!-- Folder tabs -->
    <div class="folders-bar" id="folders-bar"></div>
    <div class="results-grid" id="favorites-grid"></div>
  </div>

  <!-- LOCAL RECIPES SECTION -->
  <div id="local-section">
    <div class="section-divider"></div>
    <div class="section-header">
      <h2 class="section-title" data-i18n="local.sectionTitle">My Local Recipes</h2>
      <button class="btn-secondary" id="btn-close-local-section" data-i18n="local.hide">Hide</button>
    </div>
    <div class="local-recipes-list" id="local-section-list"></div>
  </div>

</div>

<!-- EDIT RECIPE MODAL -->
<div class="edit-overlay" id="edit-overlay">
  <div class="edit-modal">
    <div class="edit-modal-header">
      <span class="edit-modal-title">Edit Recipe</span>
      <button class="btn-edit-cancel" id="btn-edit-close" style="padding:6px 12px;font-size:12px">‚úï</button>
    </div>
    <div class="edit-modal-body" id="edit-modal-body">
      <!-- filled by JS -->
    </div>
    <div class="edit-modal-footer">
      <button class="btn-edit-cancel" id="btn-edit-cancel">Cancel</button>
      <button class="btn-edit-save" id="btn-edit-save">Save Changes</button>
    </div>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal-overlay" role="dialog" aria-modal="true">
  <div class="modal" id="modal">
    <div id="modal-img-wrap"></div>
    <div class="modal-header" style="position:relative">
      <h2 class="modal-title" id="modal-title"></h2>
      <div class="modal-meta" id="modal-meta"></div>
      <button id="btn-modal-edit" title="Edit recipe" style="display:none;position:absolute;top:16px;right:16px;background:transparent;border:1px solid var(--border);border-radius:8px;color:var(--text-secondary);font-size:13px;width:34px;height:34px;cursor:pointer;transition:var(--transition);align-items:center;justify-content:center;font-family:var(--font-body)">‚úé</button>
    </div>
    <div class="modal-body" id="modal-body"></div>
    <div class="translate-notice" id="translate-notice">Content automatically translated.</div>
    <div class="modal-footer">
      <button class="btn-close-modal" id="btn-close-modal" data-i18n="modal.close">Close</button>
      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button class="btn-translate" id="btn-translate-modal" style="display:none">
          <span class="translate-spinner"></span>
          <span id="btn-translate-label">üåê Translate</span>
        </button>
        <button class="btn-translate" id="btn-modal-share" style="display:none" title="Share recipe">
          ‚Üó Share
        </button>
        <button class="btn-save-recipe" id="btn-save-modal" data-i18n="modal.save">Save to Favorites</button>
      </div>
    </div>
    <div class="score-section" id="score-section" style="display:none;padding:0 28px 20px">
      <span class="score-label">Rate this recipe</span>
      <div class="score-row">
        <span class="score-emoji" id="score-emoji">üòê</span>
        <input type="range" class="score-slider" id="score-slider" min="0" max="100" step="1" value="70">
        <span class="score-value" id="score-display">70</span>
        <button class="btn-save-score" id="btn-save-score">Save score</button>
      </div>
    </div>
  </div>
</div>

<footer class="footer"><span data-i18n="footer.text">FoodFinder &mdash; Discover recipes from what you have</span></footer>

<script>
// Set PDF.js worker
if (typeof pdfjsLib !== 'undefined') {
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
}

// ============================================================
//  CONFIG ‚Äî paste your API keys here
// ============================================================
const CONFIG = {
  SPOONACULAR_KEY: '',        // https://spoonacular.com/food-api
  EDAMAM_APP_ID: '',          // https://developer.edamam.com/
  EDAMAM_APP_KEY: '',
  LIBRE_TRANSLATE_URL: 'https://libretranslate.com/translate',
  LIBRE_TRANSLATE_KEY: '',    // https://libretranslate.com
  GOOGLE_TRANSLATE_KEY: '',   // https://cloud.google.com/translate
  RECIPE_API: 'mealdb',       // 'mealdb' | 'spoonacular' | 'edamam'
  TRANSLATE_API: 'none',      // 'none' | 'libre' | 'google'
};

// ============================================================
//  GERMAN ‚Üí ENGLISH ingredient translation map
//  Covers common German ingredient names so search works in DE
// ============================================================
const DE_TO_EN = {
  // proteins
  'h√ºhnchen':'chicken','h√§hnchen':'chicken','huhn':'chicken','h√ºnchen':'chicken',
  'rindfleisch':'beef','rind':'beef','schweinefleisch':'pork','schwein':'pork',
  'lamm':'lamb','truthahn':'turkey','pute':'turkey','lachs':'salmon','thunfisch':'tuna',
  'garnelen':'shrimp','krabben':'crab','muscheln':'mussels','eier':'eggs','ei':'egg',
  'tofu':'tofu','speck':'bacon','wurst':'sausage','schinken':'ham',
  // vegetables
  'tomaten':'tomatoes','tomate':'tomato','kartoffeln':'potatoes','kartoffel':'potato',
  'zwiebeln':'onions','zwiebel':'onion','knoblauch':'garlic','paprika':'bell pepper',
  'karotten':'carrots','karotte':'carrot','m√∂hren':'carrots','m√∂hre':'carrot',
  'zucchini':'zucchini','gurke':'cucumber','gurken':'cucumbers','brokkoli':'broccoli',
  'blumenkohl':'cauliflower','spinat':'spinach','salat':'lettuce','kohl':'cabbage',
  'erbsen':'peas','bohnen':'beans','linsen':'lentils','mais':'corn',
  'pilze':'mushrooms','pilz':'mushroom','aubergine':'eggplant','lauch':'leek',
  'sellerie':'celery','fenchel':'fennel','r√ºben':'beets','rote r√ºben':'beet',
  'avocado':'avocado','s√º√ükartoffel':'sweet potato',
  // grains & pasta
  'nudeln':'pasta','spaghetti':'spaghetti','reis':'rice','brot':'bread',
  'mehl':'flour','haferflocken':'oats','quinoa':'quinoa','linsen':'lentils',
  // dairy
  'milch':'milk','k√§se':'cheese','butter':'butter','sahne':'cream',
  'joghurt':'yogurt','quark':'quark','mozzarella':'mozzarella',
  // fruits
  '√§pfel':'apples','apfel':'apple','bananen':'bananas','banane':'banana',
  'zitronen':'lemons','zitrone':'lemon','limetten':'limes','limette':'lime',
  'orangen':'oranges','orange':'orange','beeren':'berries','erdbeeren':'strawberries',
  'tomaten':'tomatoes',
  // herbs & spices
  'basilikum':'basil','petersilie':'parsley','rosmarin':'rosemary','thymian':'thyme',
  'oregano':'oregano','kurkuma':'turmeric','ingwer':'ginger','zimt':'cinnamon',
  'paprikapulver':'paprika','cayennepfeffer':'cayenne','pfeffer':'pepper',
  'salz':'salt','zucker':'sugar','oliven√∂l':'olive oil','√∂l':'oil',
  // other
  'br√ºhe':'broth','h√ºhnerbr√ºhe':'chicken broth','fleischbr√ºhe':'beef broth',
  'tomatenso√üe':'tomato sauce','essig':'vinegar','sojasauce':'soy sauce',
  'kokosmilch':'coconut milk','honig':'honey','senf':'mustard',
};

function translateQueryToEnglish(query) {
  // Split by comma or space, translate each token if it exists in map
  const terms = query.toLowerCase().split(/[,\s]+/).filter(Boolean);
  const translated = terms.map(term => DE_TO_EN[term] || term);
  // Return unique values
  return [...new Set(translated)].join(',');
}

// ============================================================
//  i18n
// ============================================================
const LANG = {
  en: {
    'nav.favorites':'Favorites','nav.upload':'Add Recipe',
    'hero.eyebrow':'Ingredient-based recipe discovery',
    'hero.title':"What's in your kitchen?",'hero.subtitle':"Enter ingredients you have and we'll find recipes you can make right now.",
    'search.placeholder':'e.g. chicken, garlic, tomatoes...','search.btn':'Search','search.clear':'Clear',
    'filter.toggle':'Filters','filter.diet':'Diet','filter.vegetarian':'Vegetarian','filter.vegan':'Vegan',
    'filter.glutenFree':'Gluten Free','filter.dairyFree':'Dairy Free','filter.difficulty':'Difficulty',
    'filter.any':'Any','filter.easy':'Easy','filter.medium':'Medium','filter.hard':'Hard',
    'filter.maxTime':'Max Cooking Time','sort.label':'Sort:','sort.relevance':'Relevance',
    'sort.time':'Time','sort.calories':'Calories','fav.title':'Saved Recipes','fav.clearAll':'Clear All',
    'fav.save':'Save','fav.saved':'Saved','fav.remove':'Remove',
    'modal.close':'Close','modal.save':'Save to Favorites','modal.saved':'Saved',
    'modal.ingredients':'Ingredients','modal.instructions':'Instructions',
    'modal.translatedNotice':'Content automatically translated to German.',
    'state.noResults':'No recipes found','state.noResultsSub':'Try different ingredients or adjust filters.',
    'state.error':'Something went wrong','state.errorSub':'Check your connection or API configuration.',
    'state.start':'Ready to cook','state.startSub':'Enter ingredients above and hit Search.',
    'state.noFavs':'No saved recipes yet','state.noFavsSub':'Save recipes while browsing to see them here.',
    'results.count':'{n} recipes found','footer.text':'FoodFinder \u2014 Discover recipes from what you have',
    'meta.time':'Time','meta.category':'Category','meta.area':'Cuisine','meta.calories':'Calories',
    'timeAny':'Any','timeMin':'{n} min',
    'upload.title':'Add Local Recipe','upload.dropTitle':'Drop your recipe PDFs here',
    'upload.dropSub':'or click to browse \u2014 supports multiple files \u2014 stored locally in browser',
    'upload.processing':'Parsing PDF...','upload.done':'Recipe added!','upload.error':'Could not parse PDF.',
    'upload.noLocal':'No local recipes added yet.','upload.view':'View','upload.delete':'Delete',
    'local.badge':'LOCAL','nav.local':'My Recipes',
    'local.sectionTitle':'My Local Recipes','local.hide':'Hide',
    'modal.translate':'üåê Translate to English','modal.translateDe':'üåê Translate to German','modal.translating':'Translating...','modal.translated':'‚úì Translated',
  },
  de: {
    'nav.favorites':'Favoriten','nav.upload':'Rezept hinzuf\u00fcgen',
    'hero.eyebrow':'Rezeptsuche nach Zutaten',
    'hero.title':'Was ist in deiner K\u00fcche?','hero.subtitle':'Gib Zutaten ein und wir finden passende Rezepte.',
    'search.placeholder':'z.B. H\u00e4hnchen, Knoblauch, Tomaten...','search.btn':'Suchen','search.clear':'L\u00f6schen',
    'filter.toggle':'Filter','filter.diet':'Di\u00e4t','filter.vegetarian':'Vegetarisch','filter.vegan':'Vegan',
    'filter.glutenFree':'Glutenfrei','filter.dairyFree':'Laktosefrei','filter.difficulty':'Schwierigkeit',
    'filter.any':'Beliebig','filter.easy':'Leicht','filter.medium':'Mittel','filter.hard':'Schwer',
    'filter.maxTime':'Max. Kochzeit','sort.label':'Sortieren:','sort.relevance':'Relevanz',
    'sort.time':'Zeit','sort.calories':'Kalorien','fav.title':'Gespeicherte Rezepte','fav.clearAll':'Alle l\u00f6schen',
    'fav.save':'Speichern','fav.saved':'Gespeichert','fav.remove':'Entfernen',
    'modal.close':'Schlie\u00dfen','modal.save':'Zu Favoriten hinzuf\u00fcgen','modal.saved':'Gespeichert',
    'modal.ingredients':'Zutaten','modal.instructions':'Zubereitung',
    'modal.translatedNotice':'Inhalt automatisch ins Deutsche \u00fcbersetzt.',
    'state.noResults':'Keine Rezepte gefunden','state.noResultsSub':'Versuche andere Zutaten oder passe die Filter an.',
    'state.error':'Etwas ist schiefgelaufen','state.errorSub':'Bitte \u00fcberpr\u00fcfe deine Verbindung oder API-Konfiguration.',
    'state.start':'Bereit zum Kochen','state.startSub':'Zutaten eingeben und auf Suchen klicken.',
    'state.noFavs':'Noch keine gespeicherten Rezepte','state.noFavsSub':'Speichere Rezepte beim St\u00f6bern.',
    'results.count':'{n} Rezepte gefunden','footer.text':'FoodFinder \u2014 Rezepte aus deinen Zutaten entdecken',
    'meta.time':'Zeit','meta.category':'Kategorie','meta.area':'Region','meta.calories':'Kalorien',
    'timeAny':'Beliebig','timeMin':'{n} Min.',
    'upload.title':'Lokales Rezept hinzuf\u00fcgen','upload.dropTitle':'PDF-Rezepte hier ablegen',
    'upload.dropSub':'oder klicken zum Ausw\u00e4hlen \u2014 mehrere Dateien m\u00f6glich \u2014 lokal gespeichert',
    'upload.processing':'PDF wird verarbeitet...','upload.done':'Rezept hinzugef\u00fcgt!','upload.error':'PDF konnte nicht gelesen werden.',
    'upload.noLocal':'Noch keine lokalen Rezepte.','upload.view':'Ansehen','upload.delete':'L\u00f6schen',
    'local.badge':'LOKAL','nav.local':'Meine Rezepte',
    'local.sectionTitle':'Meine lokalen Rezepte','local.hide':'Verbergen',
    'modal.translate':'üåê Ins Englische \u00fcbersetzen','modal.translateDe':'üåê Ins Deutsche \u00fcbersetzen','modal.translating':'Wird \u00fcbersetzt...','modal.translated':'\u2713 \u00dcbersetzt',
  }
};

// ============================================================
//  STATE
// ============================================================
let state = {
  lang: localStorage.getItem('ff-lang') || 'en',
  recipes: [],
  filteredRecipes: [],
  favorites: JSON.parse(localStorage.getItem('ff-favorites') || '[]'),
  localRecipes: JSON.parse(localStorage.getItem('ff-local-recipes') || '[]'),
  scores: JSON.parse(localStorage.getItem('ff-scores') || '{}'),
  folders: JSON.parse(localStorage.getItem('ff-folders') || '[]'),         // [{id, name}]
  recipeFolder: JSON.parse(localStorage.getItem('ff-recipe-folder') || '{}'), // {recipeId: folderId}
  activeFolder: 'all',  // 'all' | folderId
  favSort: 'added',
  currentRecipe: null,
  loading: false,
  sortBy: 'relevance',
  filters: { vegetarian:false, vegan:false, gluten:false, dairy:false, difficulty:'', maxTime:120 },
};

// ============================================================
//  i18n helpers
// ============================================================
function t(key, vars={}) {
  let s = (LANG[state.lang]||LANG.en)[key] || key;
  for (const [k,v] of Object.entries(vars)) s = s.replace('{'+k+'}', v);
  return s;
}

function applyI18n() {
  document.documentElement.lang = state.lang;
  document.querySelectorAll('[data-i18n]').forEach(el => el.textContent = t(el.dataset.i18n));
  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => el.placeholder = t(el.dataset.i18nPlaceholder));
  document.getElementById('btn-lang').textContent = state.lang === 'en' ? 'DE' : 'EN';
  // Update nav icon tooltips
  document.getElementById('btn-toggle-upload').setAttribute('data-tip', t('nav.upload'));
  document.getElementById('btn-toggle-upload').setAttribute('title', t('nav.upload'));
  document.getElementById('btn-show-local').setAttribute('data-tip', t('nav.local'));
  document.getElementById('btn-show-local').setAttribute('title', t('nav.local'));
  document.getElementById('btn-show-favs').setAttribute('data-tip', t('nav.favorites'));
  document.getElementById('btn-show-favs').setAttribute('title', t('nav.favorites'));
  document.getElementById('btn-changelog').setAttribute('data-tip', state.lang === 'de' ? '√Ñnderungsprotokoll' : 'Changelog');
  document.getElementById('btn-changelog').setAttribute('title', state.lang === 'de' ? '√Ñnderungsprotokoll' : 'Changelog');
  updateTimeDisplay();
}

// ============================================================
//  PARTICLES
// ============================================================
(function(){
  const canvas = document.getElementById('particle-canvas');
  const ctx = canvas.getContext('2d');
  const N = 75, DIST = 130;
  let W, H, pts;
  function resize(){ W=canvas.width=innerWidth; H=canvas.height=innerHeight; }
  function mkP(){ return { x:Math.random()*W, y:Math.random()*H, vx:(Math.random()-.5)*.3, vy:(Math.random()-.5)*.3, r:Math.random()*1.4+.4 }; }
  resize(); pts=Array.from({length:N},mkP); addEventListener('resize',resize);
  (function frame(){
    ctx.clearRect(0,0,W,H);
    for(let i=0;i<pts.length;i++){
      const p=pts[i]; p.x+=p.vx; p.y+=p.vy;
      if(p.x<0||p.x>W)p.vx*=-1; if(p.y<0||p.y>H)p.vy*=-1;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
      ctx.fillStyle='rgba(210,210,210,.6)'; ctx.fill();
      for(let j=i+1;j<pts.length;j++){
        const q=pts[j],dx=p.x-q.x,dy=p.y-q.y,d=Math.sqrt(dx*dx+dy*dy);
        if(d<DIST){ ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(q.x,q.y);
          ctx.strokeStyle='rgba(200,200,200,'+((1-d/DIST)*.14)+')'; ctx.lineWidth=.7; ctx.stroke(); }
      }
    }
    requestAnimationFrame(frame);
  })();
})();

// ============================================================
//  RECIPE APIS
// ============================================================

// TheMealDB ‚Äî free, no key
async function searchMealDB(terms) {
  const seen = new Set(), results = [];
  for (const term of terms.slice(0,4)) {
    try {
      const res = await fetch(`https://www.themealdb.com/api/json/v1/1/search.php?s=${encodeURIComponent(term)}`);
      const data = await res.json();
      if (!data.meals) continue;
      for (const m of data.meals) {
        if (!seen.has(m.idMeal)) { seen.add(m.idMeal); results.push(normalizeMeal(m)); }
      }
    } catch(e) { /* skip */ }
  }
  return results;
}

function normalizeMeal(m) {
  return {
    id: m.idMeal, title: m.strMeal, image: m.strMealThumb,
    category: m.strCategory||'', area: m.strArea||'',
    time: estimateTime(m), calories: null, difficulty: guessDiff(m),
    tags: parseTags(m), ingredients: extractIngs(m),
    instructions: m.strInstructions||'', source:'mealdb', isLocal:false,
  };
}

function extractIngs(m) {
  const items=[];
  for(let i=1;i<=20;i++){
    const ing=m['strIngredient'+i], meas=m['strMeasure'+i];
    if(ing&&ing.trim()) items.push({text:(meas?meas.trim()+' ':'')+ing.trim()});
  }
  return items;
}
function estimateTime(m){ const w=(m.strInstructions||'').split(' ').length; return Math.max(20,Math.min(90,Math.round(w/15)*5)); }
function guessDiff(m){ const s=(m.strInstructions||'').split('\n').filter(l=>l.trim()).length; return s<6?'easy':s<14?'medium':'hard'; }
function parseTags(m){ const t=[]; if(m.strTags) t.push(...m.strTags.split(',').map(x=>x.trim()).filter(Boolean)); if(m.strCategory) t.push(m.strCategory); return t; }

// Spoonacular
async function searchSpoonacular(terms) {
  if(!CONFIG.SPOONACULAR_KEY) return [];
  const url=`https://api.spoonacular.com/recipes/findByIngredients?ingredients=${encodeURIComponent(terms.join(','))}&number=20&ranking=2&apiKey=${CONFIG.SPOONACULAR_KEY}`;
  const res=await fetch(url); if(!res.ok) throw new Error('Spoonacular');
  const data=await res.json();
  const detailed=await Promise.allSettled(data.map(r=>fetch(`https://api.spoonacular.com/recipes/${r.id}/information?apiKey=${CONFIG.SPOONACULAR_KEY}`).then(r=>r.json())));
  return detailed.filter(d=>d.status==='fulfilled').map(d=>{
    const r=d.value;
    return { id:r.id, title:r.title, image:r.image, category:(r.dishTypes||[])[0]||'', area:(r.cuisines||[])[0]||'',
      time:r.readyInMinutes||null, calories:null, difficulty:r.readyInMinutes<30?'easy':r.readyInMinutes<60?'medium':'hard',
      tags:[...(r.diets||[]),...(r.dishTypes||[])], ingredients:(r.extendedIngredients||[]).map(i=>({text:i.original})),
      instructions:(r.analyzedInstructions||[]).flatMap(s=>s.steps.map(st=>st.step)).join('\n\n'),
      source:'spoonacular', isLocal:false };
  });
}

// Edamam
async function searchEdamam(terms) {
  if(!CONFIG.EDAMAM_APP_ID||!CONFIG.EDAMAM_APP_KEY) return [];
  const url=`https://api.edamam.com/search?q=${encodeURIComponent(terms.join(' '))}&app_id=${CONFIG.EDAMAM_APP_ID}&app_key=${CONFIG.EDAMAM_APP_KEY}&from=0&to=20`;
  const res=await fetch(url); if(!res.ok) throw new Error('Edamam');
  const data=await res.json();
  return (data.hits||[]).map(h=>{
    const r=h.recipe;
    return { id:btoa(r.uri), title:r.label, image:r.image, category:(r.cuisineType||[])[0]||'', area:'',
      time:r.totalTime||null, calories:Math.round((r.calories||0)/(r.yield||1)), difficulty:(r.totalTime||0)<30?'easy':(r.totalTime||0)<60?'medium':'hard',
      tags:[...(r.dietLabels||[]),...(r.healthLabels||[])], ingredients:(r.ingredientLines||[]).map(l=>({text:l})),
      instructions:'', source:'edamam', isLocal:false };
  });
}

async function fetchFromAPI(terms) {
  switch(CONFIG.RECIPE_API){
    case 'spoonacular': return searchSpoonacular(terms);
    case 'edamam': return searchEdamam(terms);
    default: return searchMealDB(terms);
  }
}

// ============================================================
//  MULTI-INGREDIENT INTERSECTION FILTER
//  Only keep recipes that contain ALL searched ingredients
// ============================================================
function recipeMatchesAllIngredients(recipe, terms) {
  if (terms.length <= 1) return true;
  const haystack = [
    recipe.title,
    ...(recipe.ingredients||[]).map(i=>i.text),
    ...(recipe.tags||[]),
    recipe.category, recipe.area,
    recipe.instructions
  ].join(' ').toLowerCase();

  return terms.every(term => haystack.includes(term.toLowerCase()));
}

// ============================================================
//  SEARCH LOCAL RECIPES
// ============================================================
function searchLocalRecipes(terms) {
  if (!terms.length) return state.localRecipes;
  return state.localRecipes.filter(r => {
    const haystack = [r.title, r.instructions, ...(r.ingredients||[]).map(i=>i.text), ...(r.tags||[])].join(' ').toLowerCase();
    return terms.some(term => haystack.includes(term.toLowerCase()));
  });
}

// ============================================================
//  TRANSLATION ‚Äî uses MyMemory (free, no API key needed)
// ============================================================
async function translateWithMyMemory(text, targetLang) {
  // MyMemory: source auto-detected, target e.g. 'de' or 'en'
  if (!text || !text.trim()) return text;
  const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text.slice(0,500))}&langpair=auto|${targetLang}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error('MyMemory error');
  const data = await res.json();
  if (data.responseStatus === 200 && data.responseData?.translatedText) {
    return data.responseData.translatedText;
  }
  throw new Error('MyMemory: ' + (data.responseDetails || 'unknown error'));
}

async function translateText(text, target) {
  if (!text) return text;
  // target: 'de' or 'en'
  return translateWithMyMemory(text, target);
}

// ============================================================
//  FILTERS & SORT
// ============================================================
function applyFiltersAndSort(recipes) {
  let r=[...recipes];
  const {vegetarian,vegan,gluten,dairy,difficulty,maxTime}=state.filters;
  if(vegan){ r=r.filter(rec=>[...(rec.tags||[]),rec.title,rec.category].join(' ').toLowerCase().includes('vegan')); }
  else if(vegetarian){ r=r.filter(rec=>[...(rec.tags||[]),rec.title,rec.category].join(' ').toLowerCase().match(/vegetarian|vegan/)); }
  if(gluten){ r=r.filter(rec=>(rec.tags||[]).join(' ').toLowerCase().includes('gluten')); }
  if(dairy){ r=r.filter(rec=>(rec.tags||[]).join(' ').toLowerCase().match(/dairy|lactose/)); }
  if(difficulty) r=r.filter(rec=>!rec.difficulty||rec.difficulty===difficulty);
  if(maxTime<120) r=r.filter(rec=>!rec.time||rec.time<=maxTime);
  if(state.sortBy==='time') r.sort((a,b)=>(a.time||999)-(b.time||999));
  else if(state.sortBy==='calories') r.sort((a,b)=>(a.calories||9999)-(b.calories||9999));
  return r;
}

// ============================================================
//  RENDER
// ============================================================
function renderResults(recipes, targetId, isFav=false) {
  const grid = document.getElementById(targetId);
  if (!recipes.length) {
    grid.innerHTML=`<div class="state-msg"><h3>${t(isFav?'state.noFavs':'state.noResults')}</h3><p>${t(isFav?'state.noFavsSub':'state.noResultsSub')}</p></div>`;
    return;
  }
  grid.innerHTML = recipes.map(r=>buildCard(r,isFav)).join('');
  grid.querySelectorAll('.recipe-card').forEach(card => {
    card.addEventListener('click', e => { if(e.target.closest('.card-fav-btn')||e.target.closest('.card-folder-btn')) return; openModal(card.dataset.id); });
    card.addEventListener('keydown', e => { if((e.key==='Enter'||e.key===' ')&&!e.target.closest('.card-fav-btn')&&!e.target.closest('.card-folder-btn')) openModal(card.dataset.id); });
  });
  grid.querySelectorAll('.card-fav-btn').forEach(btn => btn.addEventListener('click', ()=>toggleFavorite(btn.dataset.id)));
}

function buildCard(recipe, isFav=false) {
  const isSaved = state.favorites.some(f=>f.id===recipe.id);
  const favLabel = isFav ? t('fav.remove') : (isSaved ? t('fav.saved') : t('fav.save'));
  const tags = (recipe.tags||[]).slice(0,2).map(tag=>`<span class="tag">${tag}</span>`).join('');
  const imgEl = recipe.image
    ? `<img class="card-img" src="${recipe.image}" alt="${recipe.title}" loading="lazy" onerror="this.style.display='none'">`
    : recipe.pdfImageDataUrl
      ? `<img class="card-img" src="${recipe.pdfImageDataUrl}" alt="${recipe.title}" loading="lazy" style="object-position:top">`
      : `<div class="card-placeholder">${recipe.title.charAt(0)}</div>`;
  const localBadge = recipe.isLocal ? `<span class="local-badge" style="position:static;display:inline-block">${t('local.badge')}</span>` : '';
  const score = state.scores[String(recipe.id)];
  const scoreBadge = score !== undefined ? `<span class="card-score">${score}/100</span>` : '';
  // Folder button only on favorite cards ‚Äî shown top-left beside local badge
  let folderBtn = '';
  if (isFav) {
    const assignedFid = state.recipeFolder[String(recipe.id)];
    const folder = assignedFid ? state.folders.find(f=>f.id===assignedFid) : null;
    folderBtn = `<button class="card-folder-btn${folder?' assigned':''}" data-id="${recipe.id}">${folder ? 'üìÅ '+escHtmlSimple(folder.name) : 'üìÅ Folder'}</button>`;
  }
  return `
  <article class="recipe-card${recipe.isLocal?' local-card':''}" data-id="${recipe.id}" tabindex="0" role="button" aria-label="${recipe.title}">
    <div class="card-img-wrap">
      ${imgEl}
      <button class="card-fav-btn${isSaved?' saved':''}" data-id="${recipe.id}">${favLabel}</button>
      <div class="card-top-left">${localBadge}${folderBtn}</div>
      ${tags?`<div class="card-tags">${tags}</div>`:''}
      ${scoreBadge}
    </div>
    <div class="card-body">
      <h3 class="card-title">${recipe.title}</h3>
      ${recipe.description?`<p class="card-desc">${recipe.description}</p>`:''}
      <div class="card-meta">
        ${recipe.category?`<div class="meta-item"><span>${t('meta.category')}</span><strong>${recipe.category}</strong></div>`:''}
        ${recipe.time?`<div class="meta-item"><span>${t('meta.time')}</span><strong>${recipe.time} min</strong></div>`:''}
        ${recipe.calories?`<div class="meta-item"><span>${t('meta.calories')}</span><strong>${recipe.calories} kcal</strong></div>`:''}
      </div>
    </div>
  </article>`;
}

function renderSkeletons() {
  document.getElementById('results-grid').innerHTML = Array(6).fill(`
    <div class="skeleton-card"><div class="skeleton-img"></div><div class="skeleton-body">
      <div class="skeleton-line"></div><div class="skeleton-line short"></div>
    </div></div>`).join('');
}

function setStateMsg(titleKey, subKey, targetId='results-grid') {
  document.getElementById(targetId).innerHTML=`<div class="state-msg"><h3>${t(titleKey)}</h3><p>${t(subKey)}</p></div>`;
}

// ============================================================
//  MODAL ‚Äî with translate button + PDF image support
// ============================================================

let _modalTranslated = false;
let _modalOriginalIngredients = null;
let _modalOriginalInstructions = null;

async function openModal(id) {
  const allRecipes = [...state.recipes, ...state.favorites, ...state.localRecipes];
  const recipe = allRecipes.find(r=>String(r.id)===String(id));
  if (!recipe) return;
  state.currentRecipe = recipe;

  _modalTranslated = false;
  _modalOriginalIngredients = null;
  _modalOriginalInstructions = null;

  // Image: prefer stored image, then PDF canvas image, then placeholder
  const imgWrap = document.getElementById('modal-img-wrap');
  if (recipe.image) {
    imgWrap.innerHTML = `<img class="modal-img" src="${recipe.image}" alt="${recipe.title}" onerror="this.style.display='none'">`;
  } else if (recipe.pdfImageDataUrl) {
    imgWrap.innerHTML = `<img class="modal-img" src="${recipe.pdfImageDataUrl}" alt="${recipe.title}" style="object-position:top">`;
  } else {
    imgWrap.innerHTML = `<div class="modal-img-placeholder">${recipe.title.charAt(0)}</div>`;
  }

  document.getElementById('modal-title').textContent = recipe.title;
  document.getElementById('modal-body').innerHTML=`<div class="modal-loading"><div class="loading-dots"><div class="loading-dot"></div><div class="loading-dot"></div><div class="loading-dot"></div></div></div>`;
  document.getElementById('translate-notice').classList.remove('visible');

  const isSaved = state.favorites.some(f=>f.id===recipe.id);
  const saveBtn = document.getElementById('btn-save-modal');
  saveBtn.textContent = isSaved ? t('modal.saved') : t('modal.save');
  saveBtn.className = 'btn-save-recipe'+(isSaved?' saved':'');

  // Score section ‚Äî always show for saved recipes
  const scoreSection = document.getElementById('score-section');
  const scoreSlider = document.getElementById('score-slider');
  const scoreDisplay = document.getElementById('score-display');
  const scoreEmoji = document.getElementById('score-emoji');
  if (isSaved) {
    scoreSection.style.display = 'block';
    const existingScore = state.scores[String(recipe.id)];
    const sv = existingScore !== undefined ? existingScore : 70;
    scoreSlider.value = sv;
    scoreDisplay.textContent = sv;
    scoreEmoji.textContent = scoreToEmoji(sv);
  } else {
    scoreSection.style.display = 'none';
  }

  // Show translate button for API recipes (likely English) or local German recipes
  const translateBtn = document.getElementById('btn-translate-modal');
  const translateLabel = document.getElementById('btn-translate-label');
  const isLikelyGerman = recipe.isLocal || recipe.source === 'local';
  const isLikelyEnglish = !recipe.isLocal;
  translateBtn.style.display = 'flex';
  translateBtn.disabled = false;
  translateBtn.classList.remove('translating');
  translateLabel.textContent = isLikelyGerman ? t('modal.translate') : t('modal.translateDe');

  // Show/hide edit button (only for local recipes)
  const modalEditBtn = document.getElementById('btn-modal-edit');
  const modalShareBtn = document.getElementById('btn-modal-share');
  if (recipe.isLocal) {
    modalEditBtn.style.display = 'flex';
    modalEditBtn.onclick = () => { closeModal(); openEditModal(recipe.id); };
    modalShareBtn.style.display = 'flex';
    modalShareBtn.onclick = () => { closeModal(); openShareModal(recipe.id); };
  } else {
    modalEditBtn.style.display = 'none';
    modalEditBtn.onclick = null;
    modalShareBtn.style.display = 'none';
    modalShareBtn.onclick = null;
  }

  let metaHTML='';
  if(recipe.time) metaHTML+=`<div class="modal-meta-item"><span>${t('meta.time')}</span><strong>${recipe.time} min</strong></div>`;
  if(recipe.category) metaHTML+=`<div class="modal-meta-item"><span>${t('meta.category')}</span><strong>${recipe.category}</strong></div>`;
  if(recipe.area) metaHTML+=`<div class="modal-meta-item"><span>${t('meta.area')}</span><strong>${recipe.area}</strong></div>`;
  if(recipe.calories) metaHTML+=`<div class="modal-meta-item"><span>${t('meta.calories')}</span><strong>${recipe.calories} kcal</strong></div>`;
  if(recipe.difficulty) metaHTML+=`<div class="modal-meta-item"><span>${t('filter.difficulty')}</span><strong>${t('filter.'+recipe.difficulty)}</strong></div>`;
  document.getElementById('modal-meta').innerHTML=metaHTML;

  const overlay = document.getElementById('modal-overlay');
  overlay.classList.add('open');
  document.body.style.overflow='hidden';

  renderModalContent(recipe.ingredients||[], recipe.instructions||'', false);
}

function renderModalContent(ingredients, instructions, translated) {
  let bodyHTML='';
  const recipe = state.currentRecipe;

  if (recipe && recipe._aiParsed) {
    bodyHTML += `<div class="ai-parsed-note">‚ú® AI-parsed from PDF ‚Äî ingredients and instructions automatically identified</div>`;
  }

  if(ingredients&&ingredients.length) {
    bodyHTML+=`<p class="modal-section-title">${t('modal.ingredients')}</p>
    <div class="ingredients-list">${ingredients.map(i=>`<div class="ingredient-item">${i.text}</div>`).join('')}</div>`;
  }
  if(instructions) {
    const rawSteps = instructions.split(/\r?\n+/).map(s=>s.replace(/^\d+[\.\)]\s*/,'').trim()).filter(s=>s.length>8);
    const steps = rawSteps.length ? rawSteps : instructions.split(/\.\s+/).filter(s=>s.length>8).map(s=>s+'.');
    bodyHTML+=`<p class="modal-section-title">${t('modal.instructions')}</p>
    <div class="instructions-list">${steps.map((s,i)=>`<div class="instruction-step"><span class="step-num">${i+1}</span><span class="step-text">${s}</span></div>`).join('')}</div>`;
  }
  if(!bodyHTML) bodyHTML=`<p style="color:var(--text-muted);font-size:13px;padding:10px 0">${t('state.noResultsSub')}</p>`;
  if(translated) {
    bodyHTML += `<p style="font-size:11px;color:var(--text-muted);margin-top:16px;padding-top:12px;border-top:1px solid var(--border)">üåê Automatically translated</p>`;
  }
  document.getElementById('modal-body').innerHTML=bodyHTML;
}

async function handleTranslateClick() {
  const recipe = state.currentRecipe;
  if (!recipe) return;
  const btn = document.getElementById('btn-translate-modal');
  const label = document.getElementById('btn-translate-label');

  // If already translated, revert
  if (_modalTranslated) {
    _modalTranslated = false;
    renderModalContent(_modalOriginalIngredients, _modalOriginalInstructions, false);
    const isLikelyGerman = recipe.isLocal || recipe.source === 'local';
    label.textContent = isLikelyGerman ? t('modal.translate') : t('modal.translateDe');
    return;
  }

  _modalOriginalIngredients = recipe.ingredients || [];
  _modalOriginalInstructions = recipe.instructions || '';

  btn.disabled = true;
  btn.classList.add('translating');
  label.textContent = t('modal.translating');

  const isLikelyGerman = recipe.isLocal || recipe.source === 'local';
  const targetLang = isLikelyGerman ? 'en' : 'de';

  try {
    // Translate ingredients (batch as one text)
    const ingText = _modalOriginalIngredients.map(i => i.text).join('\n');
    const instrText = _modalOriginalInstructions;

    const [translatedIngText, translatedInstr] = await Promise.all([
      ingText ? translateWithMyMemory(ingText, targetLang) : Promise.resolve(''),
      instrText ? translateWithMyMemory(instrText.slice(0, 500), targetLang) : Promise.resolve('')
    ]);

    const translatedIngredients = translatedIngText
      ? translatedIngText.split('\n').filter(Boolean).map(l => ({ text: l.trim() }))
      : _modalOriginalIngredients;

    _modalTranslated = true;
    renderModalContent(translatedIngredients, translatedInstr, true);
    label.textContent = '‚Ü© ' + (targetLang === 'en' ? 'Show original (DE)' : 'Original anzeigen (EN)');
    const notice = document.getElementById('translate-notice');
    notice.textContent = targetLang === 'en'
      ? (state.lang === 'de' ? 'Ins Englische √ºbersetzt.' : 'Translated to English.')
      : (state.lang === 'de' ? 'Ins Deutsche √ºbersetzt.' : 'Translated to German.');
    notice.classList.add('visible');

  } catch (e) {
    console.error('Translation failed:', e);
    label.textContent = '‚ö† Translation failed, try again';
  }

  btn.disabled = false;
  btn.classList.remove('translating');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
  document.body.style.overflow='';
}

function scoreToEmoji(v) {
  if (v >= 90) return 'ü§©';
  if (v >= 75) return 'üòã';
  if (v >= 55) return 'üòä';
  if (v >= 35) return 'üòê';
  if (v >= 15) return 'üòï';
  return 'üò¨';
}

function saveRecipeScore(id, score) {
  state.scores[String(id)] = score;
  localStorage.setItem('ff-scores', JSON.stringify(state.scores));
  // Refresh cards to show updated score badge
  if (state.filteredRecipes.length) renderResults(state.filteredRecipes, 'results-grid');
  renderFavorites();
}

// ============================================================
//  FAVORITES
// ============================================================
function toggleFavorite(id) {
  const idx = state.favorites.findIndex(f=>String(f.id)===String(id));
  if(idx>-1) {
    state.favorites.splice(idx,1);
    // Hide score section if currently viewing this recipe
    if(state.currentRecipe && String(state.currentRecipe.id)===String(id)){
      document.getElementById('score-section').style.display='none';
    }
  } else {
    const recipe = [...state.recipes, ...state.favorites, ...state.localRecipes].find(r=>String(r.id)===String(id));
    if(recipe) state.favorites.push(recipe);
    // Show score section if currently viewing this recipe
    if(state.currentRecipe && String(state.currentRecipe.id)===String(id)){
      const scoreSection = document.getElementById('score-section');
      scoreSection.style.display = 'block';
      const existingScore = state.scores[String(id)];
      const sv = existingScore !== undefined ? existingScore : 70;
      document.getElementById('score-slider').value = sv;
      document.getElementById('score-display').textContent = sv;
      document.getElementById('score-emoji').textContent = scoreToEmoji(sv);
    }
  }
  localStorage.setItem('ff-favorites', JSON.stringify(state.favorites));
  refreshFavButtons(id);
  renderFavorites();
}

function refreshFavButtons(id) {
  const isSaved = state.favorites.some(f=>String(f.id)===String(id));
  document.querySelectorAll(`.card-fav-btn[data-id="${id}"]`).forEach(btn=>{
    btn.textContent=isSaved?t('fav.saved'):t('fav.save');
    btn.classList.toggle('saved',isSaved);
  });
  if(state.currentRecipe&&String(state.currentRecipe.id)===String(id)){
    const sb=document.getElementById('btn-save-modal');
    sb.textContent=isSaved?t('modal.saved'):t('modal.save');
    sb.className='btn-save-recipe'+(isSaved?' saved':'');
  }
}

function renderFavorites() {
  const section = document.getElementById('favorites-section');
  if (!state.favorites.length) { section.style.display='none'; return; }
  section.style.display = 'block';
  renderFolderTabs();
  renderFavGrid();
}

function saveFolderData() {
  localStorage.setItem('ff-folders', JSON.stringify(state.folders));
  localStorage.setItem('ff-recipe-folder', JSON.stringify(state.recipeFolder));
}

function getFavsSorted(favs) {
  const arr = [...favs];
  if (state.favSort === 'alpha') arr.sort((a,b) => a.title.localeCompare(b.title));
  else if (state.favSort === 'score') arr.sort((a,b) => (state.scores[String(b.id)]??-1) - (state.scores[String(a.id)]??-1));
  else if (state.favSort === 'time') arr.sort((a,b) => (a.time||999) - (b.time||999));
  // 'added' = default insertion order (already newest-first from unshift)
  return arr;
}

function getFilteredFavs() {
  if (state.activeFolder === 'all') return getFavsSorted(state.favorites);
  return getFavsSorted(state.favorites.filter(f => state.recipeFolder[String(f.id)] === state.activeFolder));
}

function renderFolderTabs() {
  const bar = document.getElementById('folders-bar');
  const allCount = state.favorites.length;

  // Count per folder
  const counts = {};
  state.folders.forEach(f => counts[f.id] = 0);
  Object.values(state.recipeFolder).forEach(fid => { if (counts[fid] !== undefined) counts[fid]++; });

  const tabsHTML = state.folders.map(f => `
    <button class="folder-tab${state.activeFolder===f.id?' active':''}" data-fid="${f.id}">
      üìÅ ${escHtmlSimple(f.name)}
      <span class="folder-count">${counts[f.id]||0}</span>
      <button class="folder-del" data-fid="${f.id}" title="Delete folder">‚úï</button>
    </button>`).join('');

  bar.innerHTML = `
    <button class="folder-tab${state.activeFolder==='all'?' active':''}" data-fid="all">
      All <span class="folder-count">${allCount}</span>
    </button>
    ${tabsHTML}
    <button class="btn-new-folder" id="btn-new-folder">+ New folder</button>`;

  bar.querySelectorAll('.folder-tab').forEach(tab => {
    tab.addEventListener('click', e => {
      if (e.target.classList.contains('folder-del')) return;
      state.activeFolder = tab.dataset.fid;
      renderFolderTabs();
      renderFavGrid();
    });
  });

  bar.querySelectorAll('.folder-del').forEach(btn => {
    btn.addEventListener('click', e => {
      e.stopPropagation();
      deleteFolder(btn.dataset.fid);
    });
  });

  document.getElementById('btn-new-folder').addEventListener('click', promptNewFolder);
}

function renderFavGrid() {
  const favs = getFilteredFavs();
  const grid = document.getElementById('favorites-grid');
  if (!favs.length) {
    grid.innerHTML = `<div class="state-msg" style="grid-column:1/-1"><h3>${state.activeFolder==='all'?t('state.noFavs'):'No recipes in this folder'}</h3><p>${state.activeFolder==='all'?t('state.noFavsSub'):'Assign favorites to this folder using the folder button on each card.'}</p></div>`;
    return;
  }
  grid.innerHTML = favs.map(r => buildCard(r, true)).join('');
  grid.querySelectorAll('.recipe-card').forEach(card => {
    card.addEventListener('click', e => { if (e.target.closest('.card-fav-btn')||e.target.closest('.card-folder-btn')) return; openModal(card.dataset.id); });
    card.addEventListener('keydown', e => { if ((e.key==='Enter'||e.key===' ')&&!e.target.closest('.card-fav-btn')&&!e.target.closest('.card-folder-btn')) openModal(card.dataset.id); });
  });
  grid.querySelectorAll('.card-fav-btn').forEach(btn => btn.addEventListener('click', ()=>toggleFavorite(btn.dataset.id)));
  grid.querySelectorAll('.card-folder-btn').forEach(btn => btn.addEventListener('click', e => { e.stopPropagation(); openFolderPicker(btn.dataset.id, btn); }));
}

function promptNewFolder() {
  const name = window.prompt('Folder name:');
  if (!name || !name.trim()) return;
  const id = 'folder_' + Date.now();
  state.folders.push({ id, name: name.trim() });
  state.activeFolder = id;
  saveFolderData();
  renderFolderTabs();
  renderFavGrid();
}

function deleteFolder(fid) {
  const folder = state.folders.find(f => f.id === fid);
  const name = folder ? folder.name : 'this folder';
  if (!confirm(`Delete folder "${name}"? Recipes won't be deleted, just removed from this folder.`)) return;
  state.folders = state.folders.filter(f => f.id !== fid);
  // Unassign recipes from this folder
  Object.keys(state.recipeFolder).forEach(rid => { if (state.recipeFolder[rid] === fid) delete state.recipeFolder[rid]; });
  if (state.activeFolder === fid) state.activeFolder = 'all';
  saveFolderData();
  renderFolderTabs();
  renderFavGrid();
}

// ‚îÄ‚îÄ Folder assignment ‚Äî simple inline dropdown ‚îÄ‚îÄ
function openFolderPicker(recipeId, anchor) {
  // If a select is already open for this recipe, close it
  const existing = document.getElementById('folder-select-' + recipeId);
  if (existing) { existing.remove(); return; }
  // Remove any other open pickers
  document.querySelectorAll('.folder-inline-select').forEach(s => s.remove());

  const currentFid = state.recipeFolder[String(recipeId)];

  const select = document.createElement('select');
  select.id = 'folder-select-' + recipeId;
  select.className = 'folder-inline-select';
  select.style.cssText = 'position:absolute;z-index:9999;background:#161616;border:1px solid rgba(255,255,255,.25);border-radius:8px;color:#f0f0f0;font-size:13px;padding:6px 10px;cursor:pointer;box-shadow:0 8px 24px rgba(0,0,0,.7);outline:none;min-width:160px';

  const options = [
    { value: '', label: '‚Äî No folder ‚Äî' },
    ...state.folders.map(f => ({ value: f.id, label: 'üìÅ ' + f.name })),
    { value: '__new__', label: '+ New folder‚Ä¶' },
  ];
  options.forEach(o => {
    const opt = document.createElement('option');
    opt.value = o.value;
    opt.textContent = o.label;
    if (o.value === currentFid) opt.selected = true;
    select.appendChild(opt);
  });

  // Position near the anchor button
  const rect = anchor.getBoundingClientRect();
  const scrollTop = window.scrollY || document.documentElement.scrollTop;
  select.style.left = Math.min(rect.left, window.innerWidth - 180) + 'px';
  select.style.top = (rect.bottom + scrollTop + 4) + 'px';
  document.body.appendChild(select);
  select.focus();

  select.addEventListener('change', () => {
    const fid = select.value;
    if (fid === '__new__') {
      select.remove();
      const name = window.prompt('New folder name:');
      if (!name || !name.trim()) return;
      const newId = 'folder_' + Date.now();
      state.folders.push({ id: newId, name: name.trim() });
      state.recipeFolder[String(recipeId)] = newId;
    } else if (fid === '') {
      delete state.recipeFolder[String(recipeId)];
      select.remove();
    } else {
      state.recipeFolder[String(recipeId)] = fid;
      select.remove();
    }
    saveFolderData();
    renderFolderTabs();
    renderFavGrid();
  });

  select.addEventListener('blur', () => setTimeout(() => select.remove(), 150));
}

function closeFolderPicker() {
  document.querySelectorAll('.folder-inline-select').forEach(s => s.remove());
}

function escHtmlSimple(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// ============================================================
//  PDF UPLOAD & LOCAL RECIPE PARSING  (v3 ‚Äî position-aware)
// ============================================================

// ---- Step 1: Extract text with layout awareness using PDF.js item positions ----
async function extractStructuredLines(arrayBuffer) {
  if (typeof pdfjsLib === 'undefined') throw new Error('PDF.js not loaded');
  pdfjsLib.GlobalWorkerOptions.workerSrc =
    'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

  const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(arrayBuffer) }).promise;
  const allLines = []; // [{text, fontSize, bold, x, y, pageY}]
  let pageOffsetY = 0;

  for (let p = 1; p <= pdf.numPages; p++) {
    const page = await pdf.getPage(p);
    const vp = page.getViewport({ scale: 1 });
    const content = await page.getTextContent({ includeMarkedContent: false });

    // Group items into visual lines by Y coordinate (within 3pt tolerance)
    const buckets = {}; // yKey ‚Üí [{str, x, fontSize, bold}]
    for (const item of content.items) {
      if (!item.str || !item.str.trim()) continue;
      const y = Math.round((vp.height - item.transform[5]) * 10) / 10; // flip PDF Y axis
      const x = Math.round(item.transform[4]);
      const fontSize = Math.abs(item.transform[3]) || 10;
      // Bold: fontName usually contains 'Bold' / 'bold' / 'Heavy' etc.
      const bold = /bold|heavy|black|demi/i.test(item.fontName || '');

      // Bucket tolerance: round to nearest 3pt bucket
      const bucket = Math.round(y / 3) * 3;
      if (!buckets[bucket]) buckets[bucket] = [];
      buckets[bucket].push({ str: item.str, x, fontSize, bold });
    }

    // Sort buckets top‚Üíbottom, within each sort left‚Üíright
    const sortedBuckets = Object.entries(buckets)
      .sort((a, b) => +a[0] - +b[0]);

    for (const [yKey, items] of sortedBuckets) {
      items.sort((a, b) => a.x - b.x);
      // Reconstruct text: if gap between items is large (>30pt) insert space
      let text = '';
      for (let i = 0; i < items.length; i++) {
        if (i > 0 && items[i].x - (items[i-1].x + items[i-1].str.length * items[i-1].fontSize * 0.55) > 28) {
          text += '  '; // double space signals column gap
        }
        text += items[i].str;
      }
      // Trim and skip empty
      text = text.replace(/\s+/g, ' ').trim();
      if (!text) continue;

      const avgFontSize = items.reduce((s, it) => s + it.fontSize, 0) / items.length;
      const isBold = items.some(it => it.bold);
      const minX = items[0].x;

      allLines.push({
        text,
        fontSize: avgFontSize,
        bold: isBold,
        x: minX,
        pageY: +yKey + pageOffsetY,
        page: p,
      });
    }
    pageOffsetY += vp.height + 20; // page gap
  }

  return allLines;
}

// ---- Step 2: Fix common PDF text extraction artifacts ----
function cleanPDFText(text) {
  return text
    // Fix split ligatures / encoding artifacts
    .replace(/Ô¨Å/g, 'fi').replace(/Ô¨Ç/g, 'fl').replace(/Ô¨Ä/g, 'ff')
    .replace(/Ô¨É/g, 'ffi').replace(/Ô¨Ñ/g, 'ffl')
    // Normalize fractions
    .replace(/¬Ω/g, '1/2').replace(/¬º/g, '1/4').replace(/¬æ/g, '3/4')
    .replace(/‚Öì/g, '1/3').replace(/‚Öî/g, '2/3').replace(/‚Öõ/g, '1/8')
    // Strip bullet chars and list markers ‚Üí normalize to nothing (we keep the text)
    .replace(/^[‚Ä¢¬∑‚ñ™‚ñ∏‚ñ∫‚Ä£‚Äí‚Äì‚Äî\-]\s*/u, '')
    // Remove stray page numbers at line start/end
    .replace(/^\d{1,3}$/, '')
    // Collapse multiple spaces
    .replace(/\s{2,}/g, ' ')
    .trim();
}

// ---- Step 3: Multi-language section header detection ----
const SECTION_PATTERNS = {
  ingredients: /^(zutaten|ingredient[s]?|you[\s']ll need|what you need|ben√∂tigt|f√ºr den|f√ºr die|f√ºr das|pour|ingr√©dient[s]?|ingredienti|ingredientes|sk≈Çadniki|ingredi√´nten|–¥–ª—è|–ø—Ä–æ–¥—É–∫—Ç—ã|mat[e]?rials?|komponenten|inhaltstoffe|was du brauchst)\s*[:\-]?\s*$/i,
  instructions: /^(zubereitung|zubereiten|anleitung|so geht[']?s|so wird[']?s gemacht|preparation|instructions?|method|directions?|steps?|how to|how to make|procedure|pr√©paration|pr√©par[e]?r|preparazione|preparaci√≥n|przygotowanie|bereiding|–ø—Ä–∏–≥–æ—Ç–æ–≤–ª–µ–Ω–∏–µ|cooking method|kochvorgang|kochanleitung|zuzubereiten|herstellung|durchf√ºhrung)\s*[:\-]?\s*$/i,
  notes: /^(notes?|tipps?|anmerkungen?|hinweise?|variations?|variationen?|serving[s]?|servieren|garnish|garnitur|to serve)\s*[:\-]?\s*$/i,
};

// Looser fallback: contains the keyword anywhere on a short header-like line
const SECTION_FALLBACK = {
  ingredients: /zutaten|ingredients?|ben√∂tigt|f√ºr \d|ingr√©dient|ingredienti/i,
  instructions: /zubereitung|zubereiten|anleitung|instruction|preparation|method|directions|steps|so geht|zuzubereiten|preparazione|pr√©paration/i,
};

// ---- Step 4: Ingredient line scoring ----
// Returns 0-100 confidence that a line is an ingredient

// Common unit words across EN/DE/FR/IT
const UNITS_RE = /\b(\d[\d\/\.,]*)\s*(g|kg|mg|ml|l|cl|dl|oz|lb|lbs|tsp|tbsp|teaspoon[s]?|tablespoon[s]?|cup[s]?|piece[s]?|pcs|stk|st√ºck|st√ºcke|el|tl|essl√∂ffel|teel√∂ffel|prise[n]?|messerspitze|bunch[es]?|bund|slice[s]?|scheibe[n]?|can[s]?|dose[n]?|jar[s]?|glas|handful[s]?|handvoll|pinch[es]?|dash[es]?|sprig[s]?|zweig[e]?|clove[s]?|zehe[n]?|large|medium|small|whole|halved|grated|diced|ganz[e]?|gro√ü[e]?|klein[e]?|mittel[e]?|gehackt|gew√ºrfelt|gerieben|gehackte[rs]?|packet[s]?|pack[s]?|pkt|pkg)\b/i;

const FRACTION_RE = /^\s*[\d¬Ω¬º¬æ‚Öì‚Öî‚Öõ\.,\/]+\s/;
const BULLET_RE = /^[‚Ä¢¬∑‚ñ™‚ñ∏‚ñ∫‚Ä£\*\-]\s/;

function scoreIngredientLine(line, fontSize, bold, avgBodyFontSize) {
  let score = 0;
  const t = cleanPDFText(line);
  if (!t || t.length < 2) return 0;
  if (t.length > 150) return 0; // too long to be an ingredient

  // Starts with number or fraction ‚Üí strong signal
  if (FRACTION_RE.test(t)) score += 35;
  // Has a unit word
  if (UNITS_RE.test(t)) score += 35;
  // Starts with bullet
  if (BULLET_RE.test(line)) score += 20;
  // Short line (ingredient lines are usually short)
  if (t.length < 60) score += 10;
  if (t.length < 35) score += 5;
  // Smaller font than title (body text size)
  if (fontSize > 0 && avgBodyFontSize > 0 && fontSize <= avgBodyFontSize * 1.05) score += 5;
  // Bold ingredient name pattern: "Butter: 200g" or "200g Butter"
  if (/\d.*[a-z√§√∂√º√ü]{3,}/i.test(t)) score += 10;
  // Common ingredient words (very broad signal)
  if (/\b(butter|mehl|zucker|salz|pfeffer|√∂l|oil|milk|egg|eggs|flour|salt|sugar|cream|water|wasser|milch|ei|eier|k√§se|cheese|tomato|onion|garlic|chicken|beef|pork|pasta|rice|lemon|vinegar|honey)\b/i.test(t)) score += 15;

  return Math.min(score, 100);
}

// ---- Step 5: Main recipe parser ----
// ---- Chefkoch-style layout detector ----
// Chefkoch PDFs have a two-column layout where:
//   LEFT column  = cooking instructions (prose paragraphs)
//   RIGHT column = ingredient list (with amounts)
// This function detects and separates them.

function detectColumnLayout(lines) {
  if (!lines.length) return { isChefkoch: false };

  // Find the X midpoint of the page
  const allX = lines.map(l => l.x).filter(x => x > 0);
  if (!allX.length) return { isChefkoch: false };
  const pageWidth = Math.max(...allX) + 100;
  const midX = pageWidth * 0.45; // ~45% for Chefkoch layout

  // Check if there's a "Zutaten" header on the right side
  const zutatenLine = lines.find(l =>
    /zutaten\s*(f[√ºu]r|for)?\s*(\d+)?\s*(portion|serving)?/i.test(l.text) && l.x > midX
  );

  // Check if substantial text exists in both columns
  const leftLines = lines.filter(l => l.x <= midX);
  const rightLines = lines.filter(l => l.x > midX);

  const isChefkoch = !!zutatenLine && leftLines.length > 3 && rightLines.length > 3;

  return { isChefkoch, midX, zutatenLine };
}

function parseRecipeFromLines(lines, filename) {
  if (!lines.length) return null;

  // Compute average body font size
  const fontSizes = lines.map(l => Math.round(l.fontSize)).filter(s => s > 6 && s < 30);
  const fsFreq = {};
  fontSizes.forEach(s => fsFreq[s] = (fsFreq[s] || 0) + 1);
  const avgBodyFontSize = +Object.entries(fsFreq).sort((a,b) => b[1]-a[1])[0]?.[0] || 11;

  // ---- Find title ----
  let titleLine = null;
  const topLines = lines.slice(0, Math.min(15, lines.length));
  const boldLarge = topLines.filter(l => (l.bold || l.fontSize > avgBodyFontSize * 1.3) && l.text.length > 2 && l.text.length < 120);
  if (boldLarge.length) {
    titleLine = boldLarge.sort((a,b) => b.fontSize - a.fontSize)[0];
  } else {
    titleLine = topLines.find(l => l.text.length > 3 && l.text.length < 120);
  }
  const title = titleLine
    ? cleanPDFText(titleLine.text)
    : filename.replace(/\.pdf$/i, '').replace(/[_\-]+/g, ' ').trim();

  // ---- Check for Chefkoch-style two-column layout ----
  const { isChefkoch, midX, zutatenLine } = detectColumnLayout(lines);

  let ingredients = [];
  let instructionSteps = [];

  if (isChefkoch) {
    // LEFT = instructions, RIGHT = ingredients
    const leftLines = lines.filter(l => l.x <= midX).sort((a,b) => a.pageY - b.pageY);
    const rightLines = lines.filter(l => l.x > midX).sort((a,b) => a.pageY - b.pageY);

    // Ingredients: right column, starting after "Zutaten f√ºr X Portionen:"
    const zutatenIdx = rightLines.findIndex(l =>
      /zutaten\s*(f[√ºu]r|for)?\s*(\d+)?/i.test(l.text)
    );
    const ingLines = zutatenIdx >= 0
      ? rightLines.slice(zutatenIdx + 1)
      : rightLines;

    // Filter out meta lines (Rezept von, etc.) and collect ingredients
    // In Chefkoch layout, ingredients are: "150 g  Mehl" (amount in bold-ish left part, name on right)
    // But since they're on the same visual line, they come merged
    ingredients = ingLines
      .map(l => ({ text: cleanPDFText(l.text) }))
      .filter(l => {
        const t = l.text;
        if (!t || t.length < 2) return false;
        // Skip meta lines
        if (/^(rezept\s*von|difficulty|schwierigkeit|kalorien|calories|arbeitszeit|gesamtzeit|koch|back|gesamt)/i.test(t)) return false;
        // Skip "Majoran zum Garnieren" type lines? No - those ARE ingredients
        // Skip very long description-like lines
        if (t.length > 100) return false;
        // Skip lines that are clearly not ingredients (no quantity and not a recognizable ingredient word)
        // Be generous - include most right-column lines
        return true;
      });

    // Instructions: left column prose
    // Filter out the title line and header-like lines
    const instLines = leftLines.filter(l => {
      const cl = cleanPDFText(l.text);
      if (!cl || cl.length < 5) return false;
      // Skip if it matches the title
      if (cl.toLowerCase() === title.toLowerCase()) return false;
      // Skip "Zubereitung" header itself
      if (/^(zubereitung|preparation|instructions?)\s*:?$/i.test(cl)) return false;
      return true;
    });

    // Merge instruction lines into paragraphs/steps
    let step = '';
    for (const l of instLines) {
      const cl = cleanPDFText(l.text);
      // A new paragraph starts if: previous ended with period AND this starts with capital
      const prevEndsPeriod = step.endsWith('.');
      const startsCapital = /^[A-Z√ú√Ñ√ñA-Z]/.test(cl);
      if (prevEndsPeriod && startsCapital && step.length > 40) {
        if (step.trim()) instructionSteps.push(step.trim());
        step = cl;
      } else {
        step += (step ? ' ' : '') + cl;
      }
    }
    if (step.trim()) instructionSteps.push(step.trim());
    // Split long combined steps at sentence boundaries
    const finalSteps = [];
    for (const s of instructionSteps) {
      // If a step is very long, split at sentence boundaries
      if (s.length > 300) {
        const sentences = s.split(/(?<=[.!?])\s+(?=[A-Z√ú√Ñ√ñ])/);
        finalSteps.push(...sentences.filter(x=>x.trim().length > 8));
      } else {
        finalSteps.push(s);
      }
    }
    instructionSteps = finalSteps;

  } else {
    // ---- Standard linear parsing (non-Chefkoch) ----
    let ingStart = -1, ingEnd = -1, instStart = -1, instEnd = -1, notesStart = -1;
    for (let i = 0; i < lines.length; i++) {
      const clean = cleanPDFText(lines[i].text);
      const isBoldOrLarge = lines[i].bold || lines[i].fontSize > avgBodyFontSize * 1.15;
      if (ingStart === -1 && (SECTION_PATTERNS.ingredients.test(clean) || (isBoldOrLarge && SECTION_FALLBACK.ingredients.test(clean)))) {
        ingStart = i + 1;
      }
      if (instStart === -1 && (SECTION_PATTERNS.instructions.test(clean) || (isBoldOrLarge && SECTION_FALLBACK.instructions.test(clean)))) {
        instStart = i + 1;
        if (ingStart > -1 && ingEnd === -1) ingEnd = i;
      }
      if (notesStart === -1 && SECTION_PATTERNS.notes.test(clean) && instStart > -1) {
        notesStart = i; instEnd = i;
      }
    }
    // Fallbacks
    if (ingStart === -1) {
      for (let i = 0; i < lines.length; i++) {
        if (SECTION_FALLBACK.ingredients.test(cleanPDFText(lines[i].text))) { ingStart = i+1; break; }
      }
    }
    if (instStart === -1) {
      for (let i = 0; i < lines.length; i++) {
        if (SECTION_FALLBACK.instructions.test(cleanPDFText(lines[i].text))) {
          instStart = i+1; if (ingStart > -1 && ingEnd === -1) ingEnd = i; break;
        }
      }
    }

    // Extract ingredients
    if (ingStart > -1) {
      const end = ingEnd > ingStart ? ingEnd : (instStart > ingStart ? instStart-1 : Math.min(ingStart+40, lines.length));
      const ingLines = lines.slice(ingStart, end);
      ingredients = ingLines
        .map(l => ({ ...l, score: scoreIngredientLine(l.text, l.fontSize, l.bold, avgBodyFontSize) }))
        .filter(l => l.score >= 20)
        .map(l => ({ text: cleanPDFText(l.text) }))
        .filter(l => l.text.length > 1);
      if (!ingredients.length) {
        ingredients = ingLines.map(l=>({text:cleanPDFText(l.text)})).filter(l=>l.text.length>1&&l.text.length<150);
      }
    }

    // Extract instructions
    if (instStart > -1) {
      const end = instEnd > instStart ? instEnd : lines.length;
      const instLines = lines.slice(instStart, end);
      let current = '';
      for (const l of instLines) {
        const clean = cleanPDFText(l.text);
        if (!clean) continue;
        const startsNew = /^\d+[\.\)]\s/.test(clean) || BULLET_RE.test(l.text) || (l.bold && clean.length < 80)
          || (current.length > 0 && clean.length > 15 && /^[A-Z√ú√Ñ√ñ]/.test(clean) && current.endsWith('.')) || current === '';
        if (startsNew && current) { instructionSteps.push(current.trim()); current = clean; }
        else { current += (current ? ' ' : '') + clean; }
      }
      if (current.trim()) instructionSteps.push(current.trim());
      instructionSteps = instructionSteps.map(s=>s.replace(/^\d+[\.\):\s]+/,'').trim()).filter(s=>s.length>8);
    }

    // Fallback: heuristic scoring
    if (!ingredients.length && !instructionSteps.length) {
      const bodyLines = lines.filter(l=>cleanPDFText(l.text).length>1);
      const scored = bodyLines.map(l=>({...l, clean:cleanPDFText(l.text), ingScore:scoreIngredientLine(l.text,l.fontSize,l.bold,avgBodyFontSize)}));
      ingredients = scored.filter(l=>l.ingScore>=30).slice(0,35).map(l=>({text:l.clean}));
      const instLines = scored.filter(l=>l.ingScore<30&&l.clean.length>20).map(l=>l.clean);
      let step='';
      for (const line of instLines) {
        if (/[.!?]$/.test(step)&&/^[A-Z√ú√Ñ√ñ]/.test(line)&&step.length>30) { if(step.trim()) instructionSteps.push(step.trim()); step=line; }
        else { step+=(step?' ':'')+line; }
      }
      if (step.trim()) instructionSteps.push(step.trim());
    }
  }

  // ---- Meta extraction ----
  const fullText = lines.map(l=>l.text).join(' ');
  const timeMatch = fullText.match(/(\d+)\s*(?:‚Äì|-|to|bis)?\s*(\d+)?\s*(min(?:utes?)?|minuten?|std\.?|stunden?|h(?:ours?)?)\b/i);
  let time = null;
  if (timeMatch) {
    const num = timeMatch[2] ? Math.round((+timeMatch[1]+ +timeMatch[2])/2) : +timeMatch[1];
    const isHour = /std|stunden?|h(?:our)?/i.test(timeMatch[3]);
    time = isHour ? num*60 : num;
    if (time > 600) time = null;
  }
  const servingsMatch = fullText.match(/(\d+)\s*(portion[e]?[n]?|serving[s]?|person[e]?[n]?|personen|serves?)\b/i);
  const servings = servingsMatch ? +servingsMatch[1] : null;
  const calMatch = fullText.match(/(\d{2,4})\s*(kcal|kalorien|calories?)\b/i);
  const calories = calMatch ? +calMatch[1] : null;
  const steps = instructionSteps.length;
  const difficulty = (time&&time<25)||steps<=3?'easy':(time&&time<60)||steps<=8?'medium':'hard';

  const textLower = fullText.toLowerCase();
  const categories = [
    [/\b(cake|torte|kuchen|tart|pie|brownie|muffin|cookie|biscuit|dessert|pudding|mousse|cheesecake)\b/,'Dessert'],
    [/\b(soup|suppe|broth|bouillon|stew|eintopf|bisque|chowder)\b/,'Soup'],
    [/\b(salad|salat|slaw|carpaccio)\b/,'Salad'],
    [/\b(pasta|spaghetti|penne|rigatoni|linguine|tagliatelle|fettuccine|lasagna|lasagne|ravioli|gnocchi)\b/,'Pasta'],
    [/\b(pizza|flatbread)\b/,'Pizza'],
    [/\b(bread|brot|br√∂tchen|roll|baguette|focaccia|sourdough|sauerteig)\b/,'Bread'],
    [/\b(risotto)\b/,'Risotto'],
    [/\b(steak|beef|rind|rindfleisch)\b/,'Beef'],
    [/\b(chicken|h√§hnchen|h√ºhnchen|huhn|poultry|gefl√ºgel)\b/,'Chicken'],
    [/\b(pork|schwein|schweinefleisch|bacon|speck|ham|schinken)\b/,'Pork'],
    [/\b(fish|fisch|salmon|lachs|tuna|thunfisch|cod|kabeljau|shrimp|garnele)\b/,'Seafood'],
    [/\b(vegetarian|vegetarisch|vegan)\b/,'Vegetarian'],
    [/\b(smoothie|shake|drink|juice|saft|cocktail|beverage|getr√§nk)\b/,'Drinks'],
    [/\b(breakfast|fr√ºhst√ºck|pancake|pfannkuchen|waffle|waffel|omelette|omelet|m√ºsli|granola)\b/,'Breakfast'],
  ];
  let category = '';
  for (const [re, cat] of categories) { if (re.test(textLower)) { category=cat; break; } }

  const tags = [];
  if (/\b(vegan)\b/.test(textLower)) tags.push('Vegan');
  else if (/\b(vegetarisch|vegetarian)\b/.test(textLower)) tags.push('Vegetarian');
  if (/\b(glutenfrei|gluten.?free)\b/.test(textLower)) tags.push('Gluten Free');
  if (/\b(laktosefrei|dairy.?free|ohne milch)\b/.test(textLower)) tags.push('Dairy Free');
  if (category && !tags.includes(category)) tags.push(category);

  return {
    id: 'local_' + Date.now() + '_' + Math.random().toString(36).slice(2),
    title, image: null, pdfImageDataUrl: null,
    category, area: '', time, servings, calories, difficulty, tags,
    ingredients,
    instructions: instructionSteps.join('\n'),
    source: 'local', isLocal: true, addedAt: Date.now(), filename,
    _stats: { ingCount: ingredients.length, stepCount: instructionSteps.length },
  };
}
async function extractPdfImage(arrayBuffer) {
  // Render first page of PDF to canvas and return as data URL
  // For Chefkoch-style: the food image is in the top-right quadrant
  try {
    if (typeof pdfjsLib === 'undefined') return null;
    const pdf = await pdfjsLib.getDocument({ data: new Uint8Array(arrayBuffer) }).promise;
    const page = await pdf.getPage(1);
    const scale = 1.5;
    const vp = page.getViewport({ scale });
    const canvas = document.createElement('canvas');
    canvas.width = vp.width;
    canvas.height = vp.height;
    const ctx = canvas.getContext('2d');
    await page.render({ canvasContext: ctx, viewport: vp }).promise;

    // Try to detect if there's an image in the right half (Chefkoch layout)
    // Crop the right ~48% and top ~40% for the food photo
    const cropX = Math.floor(vp.width * 0.48);
    const cropY = 0;
    const cropW = vp.width - cropX;
    const cropH = Math.floor(vp.height * 0.40);

    // Check if that region has non-white pixels (actual image content)
    const imgData = ctx.getImageData(cropX, cropY, cropW, cropH);
    let nonWhite = 0;
    for (let i = 0; i < imgData.data.length; i+=4) {
      const r=imgData.data[i], g=imgData.data[i+1], b=imgData.data[i+2];
      if (r < 240 || g < 240 || b < 240) nonWhite++;
    }
    const coverage = nonWhite / (cropW * cropH);

    if (coverage > 0.1) {
      // There's an image there ‚Äî crop it out
      const cropCanvas = document.createElement('canvas');
      cropCanvas.width = cropW;
      cropCanvas.height = cropH;
      cropCanvas.getContext('2d').putImageData(imgData, 0, 0);
      return cropCanvas.toDataURL('image/jpeg', 0.82);
    }

    // Fallback: try full top strip
    const topData = ctx.getImageData(0, 0, vp.width, Math.floor(vp.height * 0.35));
    let topNonWhite = 0;
    for (let i = 0; i < topData.data.length; i+=4) {
      const r=topData.data[i], g=topData.data[i+1], b=topData.data[i+2];
      if (r < 235 || g < 235 || b < 235) topNonWhite++;
    }
    if (topNonWhite / (vp.width * Math.floor(vp.height * 0.35)) > 0.08) {
      const fallbackCanvas = document.createElement('canvas');
      fallbackCanvas.width = vp.width;
      fallbackCanvas.height = Math.floor(vp.height * 0.35);
      fallbackCanvas.getContext('2d').putImageData(topData, 0, 0);
      return fallbackCanvas.toDataURL('image/jpeg', 0.75);
    }

    return null;
  } catch(e) {
    console.warn('PDF image extraction failed:', e);
    return null;
  }
}

async function handleFiles(files) {
  const progress = document.getElementById('upload-progress');
  const progressBar = document.getElementById('progress-bar');
  const progressLabel = document.getElementById('progress-label');

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    if (!file.name.toLowerCase().endsWith('.pdf')) continue;

    progress.classList.add('visible');
    progressLabel.textContent = t('upload.processing') + ' ' + file.name;
    progressBar.style.width = '10%';

    try {
      const rawBuffer = await file.arrayBuffer();
      progressBar.style.width = '25%';

      progressLabel.textContent = t('upload.processing') + ' ' + file.name;

      // PDF.js TRANSFERS (detaches) ArrayBuffers, so we must copy for each use
      let pdfImageDataUrl = null;
      try {
        pdfImageDataUrl = await extractPdfImage(rawBuffer.slice(0));
      } catch(imgErr) {
        console.warn('Image extraction failed (non-fatal):', imgErr);
      }
      progressBar.style.width = '40%';

      const structuredLines = await extractStructuredLines(rawBuffer.slice(0));
      progressBar.style.width = '60%';

      const recipe = parseRecipeFromLines(structuredLines, file.name);
      if (!recipe) throw new Error('Could not parse recipe structure');

      // Attach the extracted image
      if (pdfImageDataUrl) recipe.pdfImageDataUrl = pdfImageDataUrl;

      // ‚îÄ‚îÄ AI improvement step: send raw text to Claude for smart parsing ‚îÄ‚îÄ
      const rawText = structuredLines.map(l => l.text).join('\n');
      progressLabel.textContent = 'ü§ñ AI is reading the recipe...';
      progressBar.style.width = '75%';

      try {
        const aiResult = await aiParseRecipe(rawText, recipe.title);
        if (aiResult) {
          if (aiResult.title) recipe.title = aiResult.title;
          if (aiResult.ingredients && aiResult.ingredients.length > 0) {
            recipe.ingredients = aiResult.ingredients.map(t => ({ text: t }));
            recipe._aiParsed = true;
          }
          if (aiResult.instructions && aiResult.instructions.length > 0) {
            recipe.instructions = aiResult.instructions.join('\n');
            recipe._aiParsed = true;
          }
          if (aiResult.category) recipe.category = aiResult.category;
          if (aiResult.time) recipe.time = aiResult.time;
          recipe._stats = { ingCount: recipe.ingredients.length, stepCount: aiResult.instructions?.length || recipe._stats.stepCount };
        }
      } catch(aiErr) {
        console.warn('AI parsing failed, using basic parse:', aiErr);
      }

      progressBar.style.width = '90%';

      // Quality gate
      const ingOk = recipe.ingredients.length >= 1;
      const stepOk = recipe.instructions.trim().length > 10;
      const aiTag = recipe._aiParsed ? ' (AI parsed)' : '';
      if (!ingOk && !stepOk) {
        progressLabel.textContent = '‚ö† Low confidence parse ‚Äî check result: ' + recipe.title;
      } else {
        progressLabel.textContent = t('upload.done') + aiTag + ' ‚Äî ' + recipe.title
          + ' (' + recipe.ingredients.length + ' ingredients, '
          + recipe._stats.stepCount + ' steps)';
      }

      state.localRecipes.unshift(recipe);
      saveLocalRecipes();
      progressBar.style.width = '100%';
    } catch (e) {
      progressLabel.textContent = t('upload.error') + ' ' + file.name + ' ‚Äî ' + (e.message || e);
      console.error('PDF parse error:', e);
    }

    await new Promise(r => setTimeout(r, 900));
  }

  progressBar.style.width = '0%';
  setTimeout(() => progress.classList.remove('visible'), 600);
  renderLocalRecipesList();
}

// ============================================================
//  AI RECIPE PARSER ‚Äî uses Claude to intelligently extract
//  ingredients vs instructions from raw PDF text
// ============================================================
async function aiParseRecipe(rawText, knownTitle) {
  // Truncate very long text to avoid token limits
  const text = rawText.length > 4000 ? rawText.slice(0, 4000) : rawText;

  const prompt = `You are a recipe parser. I will give you raw text extracted from a recipe PDF. It may contain messy formatting, page numbers, copyright notices, website URLs, nutritional disclaimers, and other non-recipe content.

Your job: Extract ONLY the actual recipe content and return a clean JSON object.

Rules:
- ingredients: array of strings. Each string = one ingredient with amount (e.g. "200g flour", "2 eggs", "1 tsp salt"). Do NOT include page numbers, instructions, or metadata.
- instructions: array of strings. Each string = one clear cooking step. Do NOT include ingredient lines.
- title: the recipe name (string)
- category: one of: Dessert, Soup, Salad, Pasta, Pizza, Bread, Beef, Chicken, Pork, Seafood, Vegetarian, Breakfast, Drinks, Other
- time: cooking time in minutes as a number, or null if unknown

IMPORTANT: If a line looks like an ingredient (has amount + food name), put it in ingredients. If it's a cooking instruction, put it in instructions. If it's metadata (author, website, copyright, nutrition info, "Rezept von", difficulty rating, etc.) ‚Äî SKIP IT ENTIRELY.

Return ONLY valid JSON, no explanation, no markdown.

PDF text:
${text}`;

  const response = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true',
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 1500,
      messages: [{ role: 'user', content: prompt }]
    })
  });

  if (!response.ok) throw new Error('AI API error: ' + response.status);
  const data = await response.json();
  const text2 = data.content.map(c => c.text || '').join('');

  // Strip any markdown fences
  const clean = text2.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
  try {
    return JSON.parse(clean);
  } catch(e) {
    // Try to extract JSON object from response
    const match = clean.match(/\{[\s\S]+\}/);
    if (match) return JSON.parse(match[0]);
    throw new Error('Could not parse AI response as JSON');
  }
}

// ============================================================
//  LOCAL RECIPE HELPERS (accidentally removed ‚Äî restored)
// ============================================================
function saveLocalRecipes() {
  // pdfImageDataUrl can be large ‚Äî store without it to avoid localStorage quota issues
  const toStore = state.localRecipes.map(r => {
    const { pdfImageDataUrl, ...rest } = r;
    return rest;
  });
  try {
    localStorage.setItem('ff-local-recipes', JSON.stringify(toStore));
  } catch(e) {
    console.warn('localStorage quota exceeded, trying without images:', e);
    localStorage.setItem('ff-local-recipes', JSON.stringify(toStore));
  }
}

function renderLocalRecipesList() {
  // Render both the upload panel list and the standalone local section list
  ['local-recipes-list', 'local-section-list'].forEach(containerId => {
    const container = document.getElementById(containerId);
    if (!container) return;
    if (!state.localRecipes.length) {
      container.innerHTML = `<p style="font-size:13px;color:var(--text-muted);padding:10px 0">${t('upload.noLocal')}</p>`;
      return;
    }
    container.innerHTML = state.localRecipes.map(r => {
      const ingCount = (r.ingredients||[]).length;
      const stepCount = r.instructions ? r.instructions.split('\n').filter(s=>s.trim().length>5).length : 0;
      const score = state.scores[String(r.id)];
      const scorePill = score !== undefined ? `<span style="background:var(--surface-active);border:1px solid var(--border);border-radius:4px;font-size:10px;font-weight:700;padding:1px 6px;color:var(--text-secondary);margin-left:6px">${score}/100</span>` : '';
      const meta = [
        r.filename,
        ingCount + ' ingredient' + (ingCount !== 1 ? 's' : ''),
        stepCount + ' step' + (stepCount !== 1 ? 's' : ''),
        r.time ? r.time + ' min' : null,
        r.category || null,
      ].filter(Boolean).join(' &mdash; ');
      return `
      <div class="local-recipe-row" data-id="${r.id}">
        <div class="local-recipe-info">
          <div class="local-recipe-name">${r.title}${scorePill}</div>
          <div class="local-recipe-meta">${meta}</div>
        </div>
        <div class="local-recipe-actions">
          <button class="btn-tiny view-local" data-id="${r.id}">${t('upload.view')}</button>
          <button class="btn-tiny edit-btn edit-local" data-id="${r.id}" title="Edit recipe">&#x270F;</button>
          <button class="btn-tiny share-local" data-id="${r.id}" title="Share recipe">&#x2197;</button>
          <button class="btn-tiny danger delete-local" data-id="${r.id}">${t('upload.delete')}</button>
        </div>
      </div>`;
    }).join('');
    container.querySelectorAll('.view-local').forEach(btn => btn.addEventListener('click', () => openModal(btn.dataset.id)));
    container.querySelectorAll('.edit-local').forEach(btn => btn.addEventListener('click', () => openEditModal(btn.dataset.id)));
    container.querySelectorAll('.share-local').forEach(btn => btn.addEventListener('click', () => openShareModal(btn.dataset.id)));
    container.querySelectorAll('.delete-local').forEach(btn => btn.addEventListener('click', () => deleteLocalRecipe(btn.dataset.id)));
  });
}

// ============================================================
//  SHARE / IMPORT RECIPE
// ============================================================

function openShareModal(id) {
  const recipe = state.localRecipes.find(r => r.id === id);
  if (!recipe) return;

  // Build a clean export object ‚Äî strip image data and internal IDs
  const exportObj = {
    _ff: '1', // format marker
    title: recipe.title,
    ingredients: (recipe.ingredients || []).map(i => i.text || i),
    instructions: recipe.instructions || '',
    category: recipe.category || '',
    area: recipe.area || '',
    time: recipe.time || null,
    servings: recipe.servings || null,
    calories: recipe.calories || null,
    difficulty: recipe.difficulty || '',
    tags: recipe.tags || [],
  };

  const json = JSON.stringify(exportObj);
  // btoa with Unicode support
  const code = 'FF1:' + btoa(unescape(encodeURIComponent(json)));

  document.getElementById('share-recipe-name').textContent = recipe.title;
  document.getElementById('share-code-output').value = code;
  document.getElementById('share-overlay').style.display = 'flex';
}

function importRecipeFromCode(code) {
  code = code.trim();
  if (!code.startsWith('FF1:')) {
    return { ok: false, msg: state.lang === 'de' ? 'Ung√ºltiger Code.' : 'Invalid code.' };
  }
  try {
    const json = decodeURIComponent(escape(atob(code.slice(4))));
    const obj = JSON.parse(json);
    if (!obj._ff || !obj.title) throw new Error('Bad format');

    // Check for duplicate
    const exists = state.localRecipes.some(r => r.title === obj.title && r.source === 'shared');
    if (exists) {
      return { ok: false, msg: state.lang === 'de' ? `"${obj.title}" ist bereits vorhanden.` : `"${obj.title}" already exists.` };
    }

    const recipe = {
      id: 'local_' + Date.now() + '_' + Math.random().toString(36).slice(2),
      title: obj.title,
      image: null,
      pdfImageDataUrl: null,
      category: obj.category || '',
      area: obj.area || '',
      time: obj.time || null,
      servings: obj.servings || null,
      calories: obj.calories || null,
      difficulty: obj.difficulty || '',
      tags: obj.tags || [],
      ingredients: (obj.ingredients || []).map(t => ({ text: t })),
      instructions: obj.instructions || '',
      source: 'shared',
      isLocal: true,
      addedAt: Date.now(),
      filename: 'shared',
      _stats: { ingCount: obj.ingredients.length, stepCount: (obj.instructions || '').split('\n').filter(s => s.trim().length > 5).length },
    };

    state.localRecipes.unshift(recipe);
    saveLocalRecipes();
    renderLocalRecipesList();
    return { ok: true, msg: state.lang === 'de' ? `"${recipe.title}" importiert!` : `"${recipe.title}" imported!` };
  } catch(e) {
    return { ok: false, msg: state.lang === 'de' ? 'Fehler beim Lesen des Codes.' : 'Could not read the code.' };
  }
}

function deleteLocalRecipe(id) {
  const recipe = state.localRecipes.find(r => r.id === id);
  const name = recipe ? recipe.title : 'this recipe';
  const msg = state.lang === 'de'
    ? `‚Äû${name}" l√∂schen? Dies kann nicht r√ºckg√§ngig gemacht werden.`
    : `Delete "${name}"? This cannot be undone.`;
  if (!confirm(msg)) return;
  state.localRecipes = state.localRecipes.filter(r => r.id !== id);
  state.favorites = state.favorites.filter(f => f.id !== id);
  localStorage.setItem('ff-favorites', JSON.stringify(state.favorites));
  saveLocalRecipes();
  renderLocalRecipesList();
  renderFavorites();
}

// ============================================================
//  EDIT RECIPE MODAL
// ============================================================
let _editingId = null;

function openEditModal(id) {
  const recipe = state.localRecipes.find(r => r.id === id);
  if (!recipe) return;
  _editingId = id;

  const ingredients = (recipe.ingredients || []).map(i => i.text);
  const steps = (recipe.instructions || '').split('\n').filter(s => s.trim().length > 0);

  const currentImg = recipe.pdfImageDataUrl || recipe.image || null;

  document.getElementById('edit-modal-body').innerHTML = `
    <div>
      <label class="edit-field-label">Photo</label>
      <div class="edit-img-upload" id="edit-img-wrap">
        <input type="file" class="edit-img-input" id="edit-img-input" accept="image/*">
        ${currentImg
          ? `<img class="edit-img-preview" id="edit-img-preview" src="${currentImg}" alt="Recipe photo">
             <button type="button" class="edit-img-remove" id="edit-img-remove">‚úï Remove</button>`
          : `<div class="edit-img-placeholder"><span>üñº</span><p>Click to add a photo</p></div>`
        }
      </div>
      <p style="font-size:11px;color:var(--text-muted);margin-top:6px">üí° Recommended: under 500 KB ¬∑ ~800√ó600 px. Large images may exceed browser storage limits (localStorage ~5 MB total) and fail to save.</p>
    </div>
    <div>
      <label class="edit-field-label">Recipe Name</label>
      <input class="edit-input" id="edit-title" type="text" value="${escHtml(recipe.title)}">
    </div>
    <div>
      <label class="edit-field-label">Ingredients</label>
      <div class="edit-ing-list" id="edit-ing-list">
        ${ingredients.map((ing, i) => editIngRow(ing, i)).join('')}
      </div>
      <button class="btn-add-row" id="btn-add-ing">+ Add ingredient</button>
    </div>
    <div>
      <label class="edit-field-label">Steps</label>
      <div class="edit-step-list" id="edit-step-list">
        ${steps.map((s, i) => editStepRow(s, i)).join('')}
      </div>
      <button class="btn-add-row" id="btn-add-step">+ Add step</button>
    </div>
  `;

  bindEditListeners();
  document.getElementById('edit-overlay').classList.add('open');
  document.body.style.overflow = 'hidden';
}

function escHtml(str) {
  return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function editIngRow(value, idx) {
  return `<div class="edit-ing-row" data-idx="${idx}">
    <input class="edit-ing-input" type="text" value="${escHtml(value)}" placeholder="e.g. 200g flour">
    <button class="btn-remove-row" title="Remove">‚úï</button>
  </div>`;
}

function editStepRow(value, idx) {
  return `<div class="edit-step-row" data-idx="${idx}">
    <span class="edit-step-num">${idx+1}</span>
    <textarea class="edit-step-ta" rows="2" placeholder="Describe this step...">${escHtml(value)}</textarea>
    <button class="btn-remove-row" title="Remove">‚úï</button>
  </div>`;
}

function bindEditListeners() {
  // Image upload
  const imgInput = document.getElementById('edit-img-input');
  const imgWrap = document.getElementById('edit-img-wrap');
  imgInput.addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const dataUrl = ev.target.result;
      imgWrap.innerHTML = `
        <input type="file" class="edit-img-input" id="edit-img-input" accept="image/*">
        <img class="edit-img-preview" id="edit-img-preview" src="${dataUrl}" alt="Recipe photo">
        <button type="button" class="edit-img-remove" id="edit-img-remove">‚úï Remove</button>`;
      bindImgListeners();
    };
    reader.readAsDataURL(file);
  });
  bindImgListeners();

  // Remove ingredient rows
  document.getElementById('edit-ing-list').addEventListener('click', e => {
    const btn = e.target.closest('.btn-remove-row');
    if (btn) btn.closest('.edit-ing-row').remove();
  });
  // Remove step rows
  document.getElementById('edit-step-list').addEventListener('click', e => {
    const btn = e.target.closest('.btn-remove-row');
    if (btn) { btn.closest('.edit-step-row').remove(); renumberSteps(); }
  });
  // Add ingredient
  document.getElementById('btn-add-ing').addEventListener('click', () => {
    const list = document.getElementById('edit-ing-list');
    const div = document.createElement('div');
    div.className = 'edit-ing-row';
    div.innerHTML = editIngRow('', list.children.length);
    list.appendChild(div);
    div.querySelector('input').focus();
  });
  // Add step
  document.getElementById('btn-add-step').addEventListener('click', () => {
    const list = document.getElementById('edit-step-list');
    const div = document.createElement('div');
    div.className = 'edit-step-row';
    div.innerHTML = `<span class="edit-step-num">${list.children.length + 1}</span>
      <textarea class="edit-step-ta" rows="2" placeholder="Describe this step..."></textarea>
      <button class="btn-remove-row" title="Remove">‚úï</button>`;
    list.appendChild(div);
    div.querySelector('textarea').focus();
  });
}

function bindImgListeners() {
  const imgInput = document.getElementById('edit-img-input');
  const imgWrap = document.getElementById('edit-img-wrap');
  if (imgInput) {
    imgInput.addEventListener('change', e => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => {
        const dataUrl = ev.target.result;
        imgWrap.innerHTML = `
          <input type="file" class="edit-img-input" id="edit-img-input" accept="image/*">
          <img class="edit-img-preview" id="edit-img-preview" src="${dataUrl}" alt="Recipe photo">
          <button type="button" class="edit-img-remove" id="edit-img-remove">‚úï Remove</button>`;
        bindImgListeners();
      };
      reader.readAsDataURL(file);
    });
  }
  const removeBtn = document.getElementById('edit-img-remove');
  if (removeBtn) {
    removeBtn.addEventListener('click', e => {
      e.stopPropagation();
      imgWrap.innerHTML = `
        <input type="file" class="edit-img-input" id="edit-img-input" accept="image/*">
        <div class="edit-img-placeholder"><span>üñº</span><p>Click to add a photo</p></div>`;
      bindImgListeners();
    });
  }
}

function renumberSteps() {
  document.querySelectorAll('#edit-step-list .edit-step-num').forEach((el, i) => el.textContent = i + 1);
}

function closeEditModal() {
  document.getElementById('edit-overlay').classList.remove('open');
  document.body.style.overflow = '';
  _editingId = null;
}

function saveEditedRecipe() {
  if (!_editingId) return;
  const idx = state.localRecipes.findIndex(r => r.id === _editingId);
  if (idx === -1) return;

  const title = document.getElementById('edit-title').value.trim() || state.localRecipes[idx].title;
  const ingredients = [...document.querySelectorAll('#edit-ing-list .edit-ing-input')]
    .map(inp => inp.value.trim()).filter(Boolean).map(t => ({ text: t }));
  const steps = [...document.querySelectorAll('#edit-step-list .edit-step-ta')]
    .map(ta => ta.value.trim()).filter(Boolean);

  // Get image ‚Äî either the preview src (new upload or existing) or null if removed
  const imgPreview = document.getElementById('edit-img-preview');
  const newImg = imgPreview ? imgPreview.src : null;

  state.localRecipes[idx] = {
    ...state.localRecipes[idx],
    title,
    ingredients,
    instructions: steps.join('\n'),
    pdfImageDataUrl: newImg || null,
    _stats: { ingCount: ingredients.length, stepCount: steps.length },
    _editedAt: Date.now(),
  };

  // Also update in favorites if saved there
  const favIdx = state.favorites.findIndex(f => f.id === _editingId);
  if (favIdx > -1) {
    state.favorites[favIdx] = { ...state.favorites[favIdx], title, ingredients, instructions: steps.join('\n'), pdfImageDataUrl: newImg || null };
    localStorage.setItem('ff-favorites', JSON.stringify(state.favorites));
  }

  saveLocalRecipes();
  renderLocalRecipesList();
  renderFavorites();
  closeEditModal();
}

// ============================================================
//  MAIN SEARCH FLOW
// ============================================================
async function doSearch() {
  const rawQuery = document.getElementById('search-input').value.trim();
  if(!rawQuery || state.loading) return;

  state.loading=true;
  renderSkeletons();
  document.getElementById('sort-bar').style.display='none';

  // Parse terms ‚Äî translate German to English for API search
  const translatedQuery = translateQueryToEnglish(rawQuery);
  const terms = translatedQuery.split(/[,\s]+/).map(s=>s.trim()).filter(Boolean);
  // Also keep original terms for local search
  const originalTerms = rawQuery.split(/[,\s]+/).map(s=>s.trim()).filter(Boolean);

  try {
    // API search
    let apiRecipes = await fetchFromAPI(terms);

    // Filter: only recipes containing ALL searched ingredients
    if(terms.length > 1) {
      apiRecipes = apiRecipes.filter(r => recipeMatchesAllIngredients(r, terms));
    }

    // Search local recipes too (original + translated terms)
    const allTerms = [...new Set([...terms, ...originalTerms])];
    const localMatches = searchLocalRecipes(allTerms);

    // Search favorites too
    const favTerms = allTerms;
    const favMatches = state.favorites.filter(fav => {
      if(fav.isLocal) return false; // already in localMatches if applicable
      const haystack=[fav.title,...(fav.ingredients||[]).map(i=>i.text),...(fav.tags||[]),fav.category,fav.instructions].join(' ').toLowerCase();
      return favTerms.some(term=>haystack.includes(term.toLowerCase()));
    });

    state.recipes = [...apiRecipes];
    state.filteredRecipes = applyFiltersAndSort([...localMatches, ...favMatches, ...apiRecipes]);

    if(!state.filteredRecipes.length) {
      setStateMsg('state.noResults','state.noResultsSub');
    } else {
      renderResults(state.filteredRecipes,'results-grid');
    }

    document.getElementById('sort-bar').style.display='flex';
    document.getElementById('results-count').textContent=t('results.count',{n:state.filteredRecipes.length});

  } catch(e) {
    console.error(e);
    setStateMsg('state.error','state.errorSub');
  } finally {
    state.loading=false;
  }
}

function clearSearch() {
  document.getElementById('search-input').value='';
  document.getElementById('sort-bar').style.display='none';
  state.recipes=[]; state.filteredRecipes=[];
  setStateMsg('state.start','state.startSub');
}

// ============================================================
//  FILTER HANDLING
// ============================================================
function readFilters() {
  state.filters.vegetarian=document.getElementById('f-vegetarian').checked;
  state.filters.vegan=document.getElementById('f-vegan').checked;
  state.filters.gluten=document.getElementById('f-gluten').checked;
  state.filters.dairy=document.getElementById('f-dairy').checked;
  state.filters.difficulty=document.getElementById('f-difficulty').value;
  state.filters.maxTime=parseInt(document.getElementById('f-time').value);
  ['vegetarian','vegan','gluten','dairy'].forEach(k=>{
    document.getElementById('chip-'+k).classList.toggle('active',document.getElementById('f-'+k).checked);
  });
  if(state.recipes.length){
    state.filteredRecipes=applyFiltersAndSort(state.recipes);
    renderResults(state.filteredRecipes,'results-grid');
    document.getElementById('results-count').textContent=t('results.count',{n:state.filteredRecipes.length});
  }
}

function updateTimeDisplay() {
  const v=parseInt(document.getElementById('f-time').value);
  document.getElementById('f-time-val').textContent=v>=120?t('timeAny'):t('timeMin',{n:v});
}

// ============================================================
//  SORT
// ============================================================
function setSort(sortBy) {
  state.sortBy=sortBy;
  document.querySelectorAll('.sort-btn').forEach(btn=>btn.classList.toggle('active',btn.dataset.sort===sortBy));
  if(state.recipes.length){ state.filteredRecipes=applyFiltersAndSort(state.recipes); renderResults(state.filteredRecipes,'results-grid'); }
}

// ============================================================
//  LANGUAGE
// ============================================================
function toggleLang() {
  state.lang=state.lang==='en'?'de':'en';
  localStorage.setItem('ff-lang',state.lang);
  applyI18n();
  if(state.filteredRecipes.length) renderResults(state.filteredRecipes,'results-grid');
  renderFavorites();
  renderLocalRecipesList();
}

// ============================================================
//  EVENT LISTENERS
// ============================================================
document.getElementById('btn-search').addEventListener('click',doSearch);
document.getElementById('btn-clear').addEventListener('click',clearSearch);
document.getElementById('search-input').addEventListener('keydown',e=>{if(e.key==='Enter')doSearch();});
document.getElementById('btn-lang').addEventListener('click',toggleLang);

// Share modal
document.getElementById('btn-close-share').addEventListener('click', () => { document.getElementById('share-overlay').style.display = 'none'; });
document.getElementById('btn-close-share-2').addEventListener('click', () => { document.getElementById('share-overlay').style.display = 'none'; });
document.getElementById('share-overlay').addEventListener('click', e => { if (e.target === document.getElementById('share-overlay')) document.getElementById('share-overlay').style.display = 'none'; });
document.getElementById('btn-copy-share-code').addEventListener('click', () => {
  const ta = document.getElementById('share-code-output');
  ta.select();
  navigator.clipboard.writeText(ta.value).then(() => {
    const btn = document.getElementById('btn-copy-share-code');
    btn.textContent = '‚úì Copied!';
    setTimeout(() => btn.textContent = 'Copy Code', 2000);
  }).catch(() => {
    document.execCommand('copy');
    const btn = document.getElementById('btn-copy-share-code');
    btn.textContent = '‚úì Copied!';
    setTimeout(() => btn.textContent = 'Copy Code', 2000);
  });
});

// Import code
document.getElementById('btn-import-code').addEventListener('click', () => {
  const code = document.getElementById('import-code-input').value;
  const status = document.getElementById('import-status');
  if (!code.trim()) return;
  const result = importRecipeFromCode(code);
  status.style.display = 'block';
  status.style.color = result.ok ? '#7dff9a' : '#ff7d7d';
  status.textContent = result.ok ? '‚úì ' + result.msg : '‚úï ' + result.msg;
  if (result.ok) document.getElementById('import-code-input').value = '';
  setTimeout(() => { status.style.display = 'none'; }, 4000);
});

// Changelog
document.getElementById('btn-changelog').addEventListener('click', () => {
  document.getElementById('changelog-overlay').style.display = 'flex';
});
document.getElementById('btn-close-changelog').addEventListener('click', () => {
  document.getElementById('changelog-overlay').style.display = 'none';
});
document.getElementById('changelog-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('changelog-overlay')) {
    document.getElementById('changelog-overlay').style.display = 'none';
  }
});

document.getElementById('btn-show-favs').addEventListener('click',()=>{
  const section=document.getElementById('favorites-section');
  renderFavorites();
  if(state.favorites.length) setTimeout(()=>section.scrollIntoView({behavior:'smooth',block:'start'}),50);
});

document.getElementById('btn-show-local').addEventListener('click',()=>{
  const section=document.getElementById('local-section');
  const isVisible = section.style.display !== 'none' && section.style.display !== '';
  if(isVisible){ section.style.display='none'; return; }
  section.style.display='block';
  renderLocalRecipesList();
  setTimeout(()=>section.scrollIntoView({behavior:'smooth',block:'start'}),50);
});

document.getElementById('btn-close-local-section').addEventListener('click',()=>{
  document.getElementById('local-section').style.display='none';
});

// Upload panel toggle
document.getElementById('btn-toggle-upload').addEventListener('click',()=>{
  const panel=document.getElementById('upload-panel');
  panel.classList.toggle('visible');
  if(panel.classList.contains('visible')) renderLocalRecipesList();
});

// Filter toggle
document.getElementById('filter-toggle').addEventListener('click',()=>{
  const panel=document.getElementById('filter-panel');
  const icon=document.getElementById('filter-icon');
  const open=panel.classList.toggle('visible');
  icon.classList.toggle('open',open);
});

['f-vegetarian','f-vegan','f-gluten','f-dairy','f-difficulty'].forEach(id=>{
  document.getElementById(id).addEventListener('change',readFilters);
});
document.getElementById('f-time').addEventListener('input',()=>{updateTimeDisplay();readFilters();});

['vegetarian','vegan','gluten','dairy'].forEach(k=>{
  document.getElementById('chip-'+k).addEventListener('click',e=>{
    e.preventDefault();
    const inp=document.getElementById('f-'+k);
    inp.checked=!inp.checked;
    readFilters();
  });
});

document.querySelectorAll('.sort-btn').forEach(btn=>btn.addEventListener('click',()=>setSort(btn.dataset.sort)));

document.getElementById('btn-close-modal').addEventListener('click',closeModal);
document.getElementById('btn-translate-modal').addEventListener('click',handleTranslateClick);
document.getElementById('modal-overlay').addEventListener('click',e=>{ if(e.target===document.getElementById('modal-overlay')) closeModal(); });
document.addEventListener('keydown',e=>{ if(e.key==='Escape'){ closeModal(); closeEditModal(); document.getElementById('changelog-overlay').style.display='none'; document.getElementById('share-overlay').style.display='none'; } });

// Edit modal
document.getElementById('btn-edit-close').addEventListener('click', closeEditModal);
document.getElementById('btn-edit-cancel').addEventListener('click', closeEditModal);
document.getElementById('btn-edit-save').addEventListener('click', saveEditedRecipe);
document.getElementById('edit-overlay').addEventListener('click', e=>{ if(e.target===document.getElementById('edit-overlay')) closeEditModal(); });

document.getElementById('btn-save-modal').addEventListener('click',()=>{ if(state.currentRecipe) toggleFavorite(state.currentRecipe.id); });

// Score slider
document.getElementById('score-slider').addEventListener('input', e => {
  const v = +e.target.value;
  document.getElementById('score-display').textContent = v;
  document.getElementById('score-emoji').textContent = scoreToEmoji(v);
});
document.getElementById('btn-save-score').addEventListener('click', () => {
  if (!state.currentRecipe) return;
  const v = +document.getElementById('score-slider').value;
  saveRecipeScore(state.currentRecipe.id, v);
  const btn = document.getElementById('btn-save-score');
  btn.textContent = '‚úì Saved!';
  setTimeout(() => btn.textContent = 'Save score', 1500);
});

document.getElementById('btn-clear-all-fav').addEventListener('click',()=>{
  const msg = state.lang === 'de'
    ? 'Alle gespeicherten Rezepte l√∂schen? Dies kann nicht r√ºckg√§ngig gemacht werden.'
    : 'Clear all saved recipes? This cannot be undone.';
  if (!confirm(msg)) return;
  state.favorites=[];
  state.recipeFolder={};
  localStorage.setItem('ff-favorites',JSON.stringify([]));
  saveFolderData();
  document.getElementById('favorites-section').style.display='none';
  document.querySelectorAll('.card-fav-btn').forEach(btn=>{ btn.textContent=t('fav.save'); btn.classList.remove('saved'); });
});

// Fav sort buttons
document.querySelectorAll('.fav-sort-btn').forEach(btn => btn.addEventListener('click', () => {
  state.favSort = btn.dataset.fsort;
  document.querySelectorAll('.fav-sort-btn').forEach(b => b.classList.toggle('active', b.dataset.fsort === state.favSort));
  renderFavGrid();
}));

// PDF file input
document.getElementById('pdf-file-input').addEventListener('change',e=>{
  if(e.target.files.length) handleFiles(e.target.files);
});

// Drag and drop
const dropZone=document.getElementById('drop-zone');
dropZone.addEventListener('dragover',e=>{e.preventDefault();dropZone.classList.add('drag-over');});
dropZone.addEventListener('dragleave',()=>dropZone.classList.remove('drag-over'));
dropZone.addEventListener('drop',e=>{
  e.preventDefault(); dropZone.classList.remove('drag-over');
  if(e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
});

// ============================================================
//  INIT
// ============================================================
function init() {
  applyI18n();
  setStateMsg('state.start','state.startSub');
  renderFavorites();
}

init();
</script>
</body>
</html>
